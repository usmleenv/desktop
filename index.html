<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USMLE Env</title>

    <!-- React and Babel for Lab Values and Calculator components -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

    <!-- Chart.js for statistics graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --primary-light: #e8f0fe;
            --secondary: #5f6368;
            --accent: #1e88e5;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text: #202124;
            --text-light: #5f6368;
            --border: #dadce0;
            --hover: #f1f3f4;
            --shadow: rgba(60, 64, 67, 0.3);
            --shadow-light: rgba(60, 64, 67, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        /* Top Navigation */
        .navbar {
            background: var(--primary);
            color: white;
            height: 64px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-light);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-brand {
            font-size: 22px;
            font-weight: 600;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .navbar-stats {
            display: flex;
            gap: 32px;
            margin-right: 24px;
        }

        .stat-box {
            text-align: center;
        }

        .stats-toggle-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 14px;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .stats-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .stats-toggle-btn:active {
            transform: scale(0.95);
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
        }

        .magnify-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }

        .magnify-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.1);
        }

        .magnify-icon {
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            font-size: 16px;
            margin-left: 8px;
        }

        .magnify-icon:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .magnify-icon-inline {
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
            font-size: 14px;
            margin-left: 6px;
        }

        .magnify-icon-inline:hover {
            opacity: 1;
            transform: scale(1.15);
        }

        .overall-ids-section {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .ids-magnify-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .ids-magnify-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .navbar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .search-container {
            position: relative;
            margin-right: 12px;
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .search-input {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 14px;
            width: 300px;
            transition: all 0.2s;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-btn {
            padding: 8px 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Test Mode Navigation */
        .test-nav-arrows {
            display: none;
            gap: 8px;
            margin-right: 16px;
        }

        .test-nav-arrows.active {
            display: flex;
        }

        .arrow-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .arrow-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .arrow-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Layout */
        .container {
            display: flex;
            height: calc(100vh - 64px);
        }

        /* Test Mode Fullscreen */
        .container.test-mode {
            height: calc(100vh - 64px);
        }

        .container.test-mode .sidebar {
            width: 280px;
        }

        .container.test-mode .main-content {
            flex: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.test-mode {
            width: 280px;
        }

        /* Test Sidebar */
        .test-sidebar-header {
            padding: 16px 20px;
            background: var(--primary-light);
            border-bottom: 1px solid var(--border);
            min-height: 88px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .test-sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .test-sidebar-info {
            font-size: 12px;
            color: var(--text-light);
        }

        .test-questions-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .test-question-item {
            padding: 12px 16px;
            margin: 4px 0;
            background: var(--hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
        }

        .test-question-item:hover {
            background: var(--primary-light);
            transform: translateX(4px);
        }

        .test-question-item.active {
            background: var(--primary-light);
            border-left-color: var(--primary);
            font-weight: 600;
            box-shadow: 0 2px 4px var(--shadow-light);
        }

        .test-question-number {
            font-size: 14px;
            color: var(--text);
        }

        .test-question-item.active .test-question-number {
            color: var(--primary);
            font-weight: 700;
        }

        .test-question-status {
            display: flex;
            gap: 4px;
            font-size: 16px;
            align-items: center;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            min-height: 88px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .sidebar-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .filter-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .systems-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .system-card {
            margin-bottom: 12px;
            border-radius: 12px;
            overflow: hidden;
            background: var(--surface);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .system-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .system-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .system-name {
            font-weight: 600;
            font-size: 14px;
        }

        .system-badge {
            background: rgba(255, 255, 255, 0.25);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .topics-list {
            display: none;
            padding: 8px;
        }

        .topics-list.expanded {
            display: block;
        }

        .topic-item {
            padding: 12px 16px;
            margin: 4px 0;
            background: var(--hover);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .topic-item:hover {
            background: var(--primary-light);
            border-left-color: var(--primary);
            transform: translateX(4px);
        }

        .topic-item.active {
            background: var(--primary-light);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .topic-name {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .topic-progress {
            font-size: 11px;
            color: var(--text-light);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Test Mode Actions Bar */
        .test-actions-bar {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 50px;
            gap: 12px;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .test-actions-bar.active {
            display: flex;
        }

        .container:not(.test-mode) .test-actions-bar {
            display: none !important;
        }

        .test-action-btn {
            padding: 8px 20px;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .test-action-btn.btn-correct {
            background: var(--primary);
            color: white;
        }

        .test-action-btn.btn-correct.selected {
            border-color: #1565c0;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.3);
        }

        .test-action-btn.btn-incorrect {
            background: #fb8c00;
            color: white;
        }

        .test-action-btn.btn-incorrect.selected {
            border-color: #e65100;
            box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.3);
        }

        .answer-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 12px;
        }

        .answer-selector label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .answer-dropdown {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 60px;
        }

        .answer-dropdown:hover {
            border-color: var(--primary);
        }

        .answer-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .answer-dropdown option {
            padding: 8px;
        }

        .test-action-btn.btn-flag {
            background: #ef5350;
            color: white;
        }

        .test-action-btn.btn-flag.active {
            background: #c62828;
        }

        .test-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .content-header {
            background: var(--surface);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            min-height: 88px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .breadcrumb {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text);
        }

        .notes-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .notes-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .notes-btn:active {
            transform: translateY(0);
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Test Mode Fullscreen Question */
        .container.test-mode .content-body {
            padding: 0;
            margin: 0 24px 0 24px;
            overflow: hidden;
            position: relative;
        }

        .container.test-mode .content-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Hide text in nav buttons during test mode, keep only emojis */
        body.test-mode-active .nav-button {
            font-size: 0;
            padding: 8px 12px;
        }

        body.test-mode-active .nav-button::before {
            content: attr(data-emoji);
            font-size: 18px;
        }

        /* Fullscreen Button */
        .fullscreen-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
            pointer-events: auto;
        }

        .fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }

        /* Hide fullscreen button when in fullscreen mode */
        body.fullscreen-mode .fullscreen-btn {
            display: none;
        }

        /* Exit Fullscreen Button - same position as fullscreen button */
        .exit-fullscreen-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
            display: none;
            pointer-events: auto;
        }

        body.fullscreen-mode .exit-fullscreen-btn {
            display: block;
        }

        .exit-fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }

        /* Fullscreen Mode */
        body.fullscreen-mode .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 10000;
        }

        body.fullscreen-mode .navbar.hover-active {
            transform: translateY(0);
        }

        body.fullscreen-mode .container {
            height: 100vh !important;
            margin-top: 0 !important;
        }

        body.fullscreen-mode .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 9999;
        }

        body.fullscreen-mode .sidebar.hover-active {
            transform: translateX(0);
        }

        body.fullscreen-mode .main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }

        body.fullscreen-mode .content-body {
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Sidebar Indicator in Fullscreen */
        .sidebar-indicator {
            position: fixed;
            left: 0;
            top: 80px;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            border-radius: 0 6px 6px 0;
            padding: 8px 4px;
            cursor: pointer;
            z-index: 10000;
            transition: all 0.3s ease;
            backdrop-filter: blur(2px);
            display: none;
        }

        body.fullscreen-mode .sidebar-indicator {
            display: block;
        }

        /* Move indicator with sidebar when open - stick to right edge of sidebar */
        body.fullscreen-mode .sidebar.hover-active ~ .sidebar-indicator {
            left: 320px;
        }

        /* Adjust for test mode and viewing mode (280px sidebar) */
        body.fullscreen-mode .container.test-mode .sidebar.hover-active ~ .sidebar-indicator,
        body.fullscreen-mode .container.viewing-question .sidebar.hover-active ~ .sidebar-indicator {
            left: 280px;
        }

        body.fullscreen-mode .sidebar-indicator.hide {
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-indicator:hover {
            background: rgba(0, 0, 0, 0.6);
            padding-left: 6px;
            padding-right: 6px;
        }

        .sidebar-indicator-icon {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
        }

        .sidebar-indicator-icon span {
            width: 14px;
            height: 1.5px;
            background: rgba(255, 255, 255, 0.8);
            display: block;
            border-radius: 1px;
            transition: all 0.2s;
        }

        .sidebar-indicator:hover .sidebar-indicator-icon span {
            background: rgba(255, 255, 255, 1);
            width: 16px;
        }

        /* Questions Grid */
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            max-width: 1400px;
        }

        .question-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .question-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px var(--shadow-light);
            border-color: var(--primary);
        }

        .question-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 12px;
        }

        .question-status {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .question-card.unattempted {
            border-color: var(--border);
        }

        .question-card.unattempted .question-status {
            color: var(--text-light);
        }

        .question-card.correct {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: var(--primary);
        }

        .question-card.correct .question-status {
            color: var(--primary);
        }

        .question-card.incorrect {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-color: #fb8c00;
        }

        .question-card.incorrect .question-status {
            color: #e65100;
        }

        .flag-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 18px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            max-width: 600px;
            margin: 0 auto;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--text);
        }

        .empty-state p {
            font-size: 16px;
            color: var(--text-light);
        }

        /* Question Modal - Now Fullscreen in Normal Mode */
        #question-modal {
            display: none;
        }

        #question-modal.show {
            display: block;
        }

        .container.viewing-question .sidebar {
            width: 280px;
        }

        .container.viewing-question .main-content {
            flex: 1;
        }

        .container.viewing-question .content-body {
            padding: 0;
            margin: 0;
            overflow: hidden;
            position: relative;
        }

        .container.viewing-question .content-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Question Actions Bar (Normal Mode) */
        .question-actions-bar {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 50px;
            gap: 12px;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .question-actions-bar.active {
            display: flex;
        }

        .question-action-btn {
            padding: 8px 20px;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .question-action-btn.btn-close {
            background: var(--secondary);
            color: white;
        }

        .question-action-btn.btn-flag {
            background: #ef5350;
            color: white;
        }

        .question-action-btn.btn-correct {
            background: var(--primary);
            color: white;
        }

        .question-action-btn.btn-correct.selected {
            border-color: #1565c0;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.3);
        }

        .question-action-btn.btn-incorrect {
            background: #fb8c00;
            color: white;
        }

        .question-action-btn.btn-incorrect.selected {
            border-color: #e65100;
            box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.3);
        }

        .question-action-btn.btn-flag.active {
            background: #c62828;
        }

        .question-action-btn.btn-correct {
            background: var(--primary);
            color: white;
        }

        .question-action-btn.btn-incorrect {
            background: #fb8c00;
            color: white;
        }

        .question-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Stats Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header-bar {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border);
            background: var(--primary-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            flex: 1;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            margin-left: 16px;
        }

        .modal-close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .modal-body {
            padding: 24px 28px;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        .modal-footer {
            padding: 20px 28px 32px 28px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px var(--shadow-light);
        }

        /* Stats Display */
        .system-stats-section {
            margin-bottom: 32px;
        }

        .system-stats-header {
            background: var(--primary);
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .system-stats-title {
            font-size: 18px;
            font-weight: 600;
        }

        .system-stats-summary {
            font-size: 14px;
        }

        .topic-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .topic-stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .topic-stat-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .topic-stat-detail {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-label {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .form-text {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-warning {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ffb74d;
        }

        /* Study Planner Styles */
        .planner-card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }

        .planner-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .planner-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .planner-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .planner-card-priority {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .planner-card-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .planner-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .planner-stat-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .planner-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .planner-card-strategy {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            font-size: 14px;
            color: var(--text-light);
        }

        .planner-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .planner-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 24px;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
        }

        /* Question IDs Display */
        .ids-section {
            margin-bottom: 24px;
        }

        .ids-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .ids-section-header.correct {
            background: #e3f2fd;
            color: #1565c0;
        }

        .ids-section-header.incorrect {
            background: #fff3e0;
            color: #e65100;
        }

        .ids-section-header.unattempted {
            background: #f5f5f5;
            color: #616161;
        }

        .ids-section-header.flagged {
            background: #ffebee;
            color: #c62828;
        }

        .ids-list {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            color: #202124;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .ids-copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ids-copy-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Media Maximizer Modal - True Fullscreen */
        #media-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.98);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        #media-modal.show {
            display: flex;
        }

        #media-modal-content {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #media-modal-controls {
            position: fixed;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 16px;
            z-index: 10000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .media-control-btn {
            background: rgba(26, 115, 232, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .media-control-btn:hover {
            background: rgba(26, 115, 232, 1);
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.6);
        }

        .media-control-btn:active {
            transform: scale(0.95);
        }

        #media-display-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            padding: 20px;
        }

        #media-display {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
        }

        #media-display:active {
            cursor: grabbing;
        }

        #media-display.zoomed {
            cursor: move;
            max-width: none;
            max-height: none;
        }

        /* Media Info Overlay */
        #media-info {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 115, 232, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Improved Question Styling (injected into iframe) */
        .question-style-improvements {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.8;
            color: #202124;
            max-width: 900px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Bionic Reading Mode */
        .bionic-reading {
            font-weight: normal;
        }

        .bionic-reading .bionic-bold {
            font-weight: 700;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 6px;
            border: 3px solid var(--bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }

        /* Sidebar Float Buttons */
        .sidebar-float-btn {
            position: fixed;
            right: 16px;
            cursor: pointer;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .sidebar-float-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
            border-color: var(--primary);
        }

        .sidebar-float-btn svg {
            transition: all 0.2s ease;
        }

        .sidebar-float-btn:hover svg {
            fill: var(--primary);
        }

        #ankiConverterButton {
            bottom: 380px;
        }

        #studyPlannerButton {
            bottom: 310px;
        }

        #labValuesButton {
            bottom: 240px;
        }

        #calculatorButton {
            bottom: 170px;
        }

        #stopwatchContainer {
            bottom: 16px;
            flex-direction: column;
            width: 200px;
            padding: 16px;
            min-height: 140px;
        }

        #stopwatchIcon {
            bottom: 16px;
        }

        .stopwatch-expanded {
            padding: 16px;
        }

        .occlude-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--hover);
            border: none;
            font-size: 1.3em;
            color: var(--text-light);
            cursor: pointer;
            line-height: 1;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .occlude-btn:hover {
            background: var(--border);
            color: var(--primary);
        }

        .stopwatch-display {
            font-size: 1.5em;
            margin: 24px 0 12px 0;
            color: var(--primary);
            font-weight: 600;
            text-align: center;
            font-family: 'Segoe UI', monospace;
        }

        .stopwatch-buttons {
            display: flex;
            gap: 8px;
        }

        .stopwatch-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
        }

        .stopwatch-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .stopwatch-btn:active {
            transform: translateY(0);
        }

        .stopwatch-option {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #5f6368;
        }

        .stopwatch-option input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        .stopwatch-option label {
            cursor: pointer;
            user-select: none;
            line-height: 1.4;
        }

        /* Utility Modals */
        .utility-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(2px);
        }

        .utility-modal.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .utility-modal-content {
            background: var(--surface);
            width: 700px;
            max-width: 95%;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-modal-content {
            width: 400px;
        }

        .utility-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--primary);
            color: white;
        }

        .utility-modal-header h2 {
            margin: 0;
            font-size: 1.25em;
            font-weight: 600;
        }

        .utility-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .utility-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #labValuesRoot,
        #calculatorRoot {
            padding: 20px;
            overflow-y: auto;
        }

        /* Calculator Button Styles */
        #calculatorRoot button {
            padding: 18px;
            font-size: 18px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 500;
            box-shadow: 0 1px 3px var(--shadow-light);
        }

        #calculatorRoot button:hover {
            background: var(--hover);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px var(--shadow-light);
        }

        #calculatorRoot button:active {
            background: var(--border);
            transform: translateY(0);
            box-shadow: 0 1px 2px var(--shadow-light);
        }

        #calculatorRoot .calc-display {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-size: 2em;
            text-align: right;
            color: var(--text);
            font-family: 'Segoe UI', monospace;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* Lab Values Table Styles */
        #labValuesRoot table {
            width: 100%;
            border-collapse: collapse;
        }

        #labValuesRoot thead {
            background: var(--bg);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        #labValuesRoot th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 2px solid var(--border);
        }

        #labValuesRoot td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }

        #labValuesRoot tbody tr:hover {
            background: var(--hover);
        }

        #labValuesRoot input[type="search"] {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            transition: all 0.2s;
        }

        #labValuesRoot input[type="search"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        #labValuesRoot button {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        #labValuesRoot button:hover {
            background: var(--hover);
            border-color: var(--primary);
        }

        #labValuesRoot button[style*="bold"] {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        #labValuesRoot button[style*="bold"]:hover {
            background: var(--primary-dark);
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            animation: fadeIn 0.3s ease;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .login-screen.hidden {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .login-box {
            background: var(--surface);
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: slideUp 0.4s ease;
        }

        .login-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .login-subtitle {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 32px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .login-error {
            color: #d32f2f;
            font-size: 13px;
            margin-bottom: 16px;
            min-height: 20px;
            font-weight: 500;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .login-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(26, 115, 232, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 24px auto 0;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hide app content until authenticated */
        body:not(.authenticated) .navbar,
        body:not(.authenticated) #container,
        body:not(.authenticated) .test-nav-arrows,
        body:not(.authenticated) #ankiConverterButton,
        body:not(.authenticated) #studyPlannerButton,
        body:not(.authenticated) #labValuesButton,
        body:not(.authenticated) #calculatorButton,
        body:not(.authenticated) #stopwatchContainer {
            display: none !important;
        }

        /* Heatmap Styles */
        .heatmap-grid {
            display: inline-block;
            font-size: 10px;
        }

        .heatmap-months {
            display: flex;
            margin-bottom: 4px;
            padding-left: 28px;
        }

        .heatmap-month {
            min-width: 40px;
            font-size: 10px;
            color: var(--text-light);
        }

        .heatmap-body {
            display: flex;
        }

        .heatmap-days-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            margin-right: 8px;
            font-size: 10px;
            color: var(--text-light);
        }

        .heatmap-weeks {
            display: flex;
            gap: 3px;
        }

        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .heatmap-day:hover {
            transform: scale(1.3);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .heatmap-tooltip {
            position: absolute;
            background: var(--text);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10000;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .heatmap-tooltip-date {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .heatmap-tooltip-stat {
            font-size: 11px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-box">
            <div class="login-icon"></div>
            <div class="login-title">USMLE Env</div>
            <div class="login-subtitle">Enter password to access</div>
            <input
                type="password"
                class="login-input"
                id="password-input"
                placeholder="Password"
                onkeypress="if(event.key === 'Enter') checkPassword()"
            >
            <div class="login-error" id="login-error"></div>
            <button class="login-btn" onclick="checkPassword()">Unlock</button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="navbar">
        <div class="navbar-brand">
            <div class="brand-icon"></div>
            <span>USMLE Env</span>
        </div>
        <div class="navbar-stats">
            <button class="stats-toggle-btn" id="stats-toggle-btn" onclick="toggleStatsDisplay()" title="Toggle between absolute numbers and percentages"></button>
            <div class="stat-box">
                <div class="stat-label">Total</div>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Correct</div>
                <div class="stat-value" id="stat-correct">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Incorrect</div>
                <div class="stat-value" id="stat-incorrect">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Remaining</div>
                <div class="stat-value" id="stat-remaining">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Accuracy</div>
                <div class="stat-value" id="stat-accuracy">0%</div>
            </div>
        </div>
        <div class="navbar-actions">
            <div class="search-container">
                <input type="text" class="search-input" id="question-search" placeholder="Enter question IDs (e.g., 174, 556, 892)">
            </div>
            <button class="nav-button" id="start-test-btn" onclick="startTest()" data-emoji=""> Start Test</button>
            <button class="nav-button" id="finish-test-btn" onclick="finishTest()" style="display: none;" data-emoji=""> Finish Test</button>
            <div class="test-nav-arrows" id="test-nav-arrows">
                <button class="arrow-btn" id="prev-btn" onclick="navigateQuestion(-1)"></button>
                <button class="arrow-btn" id="next-btn" onclick="navigateQuestion(1)"></button>
            </div>
            <button class="nav-button" onclick="openStatsModal()" data-emoji=""> Stats</button>
            <button class="nav-button" onclick="openTestHistoryModal()" data-emoji=""> Test History</button>
            <button class="nav-button" onclick="openBackupModal()" data-emoji=""> Backup</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container" id="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Filter Systems</div>
                <select class="filter-select" id="system-filter">
                    <option value="">All Systems</option>
                </select>
            </div>
            <div class="systems-container" id="systems-list"></div>
        </div>

        <!-- Sidebar Indicator (visible only in fullscreen) -->
        <button class="sidebar-indicator" id="sidebar-indicator" title="Toggle sidebar" onclick="toggleSidebarFullscreen()">
            <div class="sidebar-indicator-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Test Mode Actions Bar -->
            <div class="test-actions-bar" id="test-actions-bar">
                <div class="answer-selector">
                    <label for="test-answer-select">My Answer:</label>
                    <select id="test-answer-select" class="answer-dropdown" onchange="saveSelectedAnswer()">
                        <option value="">-</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="G">G</option>
                        <option value="H">H</option>
                        <option value="I">I</option>
                        <option value="J">J</option>
                        <option value="K">K</option>
                        <option value="L">L</option>
                        <option value="M">M</option>
                        <option value="N">N</option>
                        <option value="O">O</option>
                        <option value="P">P</option>
                        <option value="Q">Q</option>
                        <option value="R">R</option>
                        <option value="S">S</option>
                        <option value="T">T</option>
                        <option value="U">U</option>
                        <option value="V">V</option>
                        <option value="W">W</option>
                        <option value="X">X</option>
                        <option value="Y">Y</option>
                        <option value="Z">Z</option>
                    </select>
                </div>
                <button class="test-action-btn btn-flag" id="test-flag-btn" onclick="toggleFlag()"> Flag</button>
                <button class="test-action-btn btn-correct" onclick="markQuestion('correct')"> Correct</button>
                <button class="test-action-btn btn-incorrect" onclick="markQuestion('incorrect')"> Incorrect</button>
            </div>
            <!-- Normal Mode Actions Bar -->
            <div class="question-actions-bar" id="question-actions-bar">
                <div class="answer-selector">
                    <label for="normal-answer-select">My Answer:</label>
                    <select id="normal-answer-select" class="answer-dropdown" onchange="saveSelectedAnswer()">
                        <option value="">-</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="G">G</option>
                        <option value="H">H</option>
                        <option value="I">I</option>
                        <option value="J">J</option>
                        <option value="K">K</option>
                        <option value="L">L</option>
                        <option value="M">M</option>
                        <option value="N">N</option>
                        <option value="O">O</option>
                        <option value="P">P</option>
                        <option value="Q">Q</option>
                        <option value="R">R</option>
                        <option value="S">S</option>
                        <option value="T">T</option>
                        <option value="U">U</option>
                        <option value="V">V</option>
                        <option value="W">W</option>
                        <option value="X">X</option>
                        <option value="Y">Y</option>
                        <option value="Z">Z</option>
                    </select>
                </div>
                <button class="question-action-btn btn-flag" id="normal-flag-btn" onclick="toggleFlag()"> Flag</button>
                <button class="question-action-btn btn-correct" onclick="markQuestion('correct')"> Correct</button>
                <button class="question-action-btn btn-incorrect" onclick="markQuestion('incorrect')"> Incorrect</button>
                <button class="question-action-btn btn-close" onclick="closeQuestion()"> Close</button>
            </div>
            <div class="content-header" id="content-header">
                <div class="breadcrumb" id="breadcrumb">Select a topic to begin</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="page-title" id="page-title">Welcome to USMLE Env</div>
                    <button class="notes-btn" id="notes-btn" onclick="openNotesModal()" style="display: none;" title="Notes for this question"></button>
                </div>
            </div>
            <div class="content-body" id="content-body">
                <div class="empty-state">
                    <div class="empty-icon"></div>
                    <h2>Ready to Study?</h2>
                    <p>Select a system and topic from the sidebar to start practicing questions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Maximizer Modal - Fullscreen Floating -->
    <div id="media-modal">
        <div id="media-modal-controls">
            <button class="media-control-btn" onclick="zoomMedia(1.25)" title="Zoom In">+</button>
            <button class="media-control-btn" onclick="zoomMedia(0.8)" title="Zoom Out"></button>
            <button class="media-control-btn" onclick="resetMediaZoom()" title="Reset"></button>
            <button class="media-control-btn" onclick="closeMediaModal()" title="Close"></button>
        </div>
        <div id="media-info">Use scroll do mouse ou botes para zoom  Arraste para mover</div>
        <div id="media-modal-content">
            <div id="media-display-container">
                <div id="media-display"></div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal" id="stats-modal">
        <div class="modal-dialog">
            <div class="modal-header-bar">
                <div class="modal-title"> Detailed Statistics by Topic</div>
                <button class="modal-close-btn" onclick="closeStatsModal()"></button>
            </div>
            <div class="modal-body" id="stats-modal-body">
                <!-- Will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="openProgressChartModal()"> Progress Chart</button>
                <button class="btn btn-primary" onclick="openHeatmapModal()"> Activity Heatmap</button>
            </div>
        </div>
    </div>

    <!-- Progress Chart Modal -->
    <div class="modal" id="progress-chart-modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header-bar">
                <div class="modal-title"> Progress Over Time</div>
                <button class="modal-close-btn" onclick="closeProgressChartModal()"></button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div>
                        <label class="form-label">Metric:</label>
                        <select id="chart-metric-filter" class="form-input" onchange="updateProgressChart()">
                            <option value="total">Total Attempted</option>
                            <option value="correct">Correct</option>
                            <option value="incorrect">Incorrect</option>
                            <option value="marked">Marked</option>
                            <option value="accuracy">Accuracy (%)</option>
                            <option value="totalTime">Total Time (minutes)</option>
                            <option value="avgTime">Avg Time per Question (seconds)</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Period:</label>
                        <select id="chart-period-filter" class="form-input" onchange="updateProgressChart()">
                            <option value="day">Daily</option>
                            <option value="week">Weekly</option>
                            <option value="month">Monthly</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Chart Type:</label>
                        <select id="chart-type-filter" class="form-input" onchange="updateProgressChart()">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Filter by System:</label>
                        <select id="chart-system-filter" class="form-input" onchange="updateProgressChart()">
                            <option value="">All Systems</option>
                        </select>
                    </div>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="progress-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Heatmap Modal -->
    <div class="modal" id="heatmap-modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header-bar">
                <div class="modal-title"> Activity Heatmap</div>
                <button class="modal-close-btn" onclick="closeHeatmapModal()"></button>
            </div>
            <div class="modal-body">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 16px;">
                    <button class="btn btn-secondary" onclick="changeHeatmapYear(-1)"> Previous Year</button>
                    <div style="font-size: 20px; font-weight: 600;" id="heatmap-year">2024</div>
                    <button class="btn btn-secondary" onclick="changeHeatmapYear(1)">Next Year </button>
                </div>
                <div id="heatmap-container" style="overflow-x: auto;">
                    <!-- Heatmap will be generated here -->
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 20px; justify-content: center;">
                    <span style="font-size: 12px; color: var(--text-light);">Less</span>
                    <div style="width: 12px; height: 12px; background: #ebedf0; border-radius: 2px;"></div>
                    <div style="width: 12px; height: 12px; background: #9be9a8; border-radius: 2px;"></div>
                    <div style="width: 12px; height: 12px; background: #40c463; border-radius: 2px;"></div>
                    <div style="width: 12px; height: 12px; background: #30a14e; border-radius: 2px;"></div>
                    <div style="width: 12px; height: 12px; background: #216e39; border-radius: 2px;"></div>
                    <span style="font-size: 12px; color: var(--text-light);">More</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal" id="backup-modal">
        <div class="modal-dialog">
            <div class="modal-header-bar">
                <div class="modal-title"> Backup & Restore</div>
                <button class="modal-close-btn" onclick="closeBackupModal()"></button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <div class="form-label">Download Backup</div>
                    <p class="form-text">Save your progress to a JSON file</p>
                    <button class="btn btn-primary" onclick="downloadBackup()"> Download</button>
                </div>
                <div class="form-section">
                    <div class="form-label">Restore Backup</div>
                    <p class="form-text">Load progress from a backup file</p>
                    <div class="alert" style="background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; margin-bottom: 12px;">
                        <strong> Migration Support</strong><br>
                        This app automatically detects and migrates backups from the old USMLE Environment app. Your marks, flags, correct/incorrect answers will be preserved!
                    </div>
                    <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="restoreBackup()">
                    <button class="btn btn-secondary" onclick="document.getElementById('restore-file').click()"> Upload Backup</button>
                </div>
                <div class="form-section">
                    <div class="form-label">Reset All Data</div>
                    <p class="form-text">Permanently delete all progress and start fresh</p>
                    <div class="alert alert-warning">
                        <strong> Warning!</strong> This action cannot be undone. Consider downloading a backup first.
                    </div>
                    <button class="btn btn-primary" onclick="confirmResetFromBackup()"> Reset Everything</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal" id="notes-modal">
        <div class="modal-dialog" style="max-width: 700px;">
            <div class="modal-header-bar">
                <div class="modal-title"> Notes for Question <span id="notes-question-id"></span></div>
                <button class="modal-close-btn" onclick="closeNotesModal()"></button>
            </div>
            <div class="modal-body">
                <textarea
                    id="notes-textarea"
                    placeholder="Write your notes here..."
                    style="width: 100%; min-height: 300px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"
                ></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveNote()"> Save</button>
                <button class="btn btn-secondary" onclick="closeNotesModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Question IDs Modal -->
    <div class="modal" id="question-ids-modal">
        <div class="modal-dialog">
            <div class="modal-header-bar">
                <div class="modal-title" id="ids-modal-title"> Question IDs</div>
                <button class="modal-close-btn" onclick="closeIdsModal()"></button>
            </div>
            <div class="modal-body" id="ids-modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Reset Modal -->
    <div class="modal" id="reset-modal">
        <div class="modal-dialog">
            <div class="modal-header-bar">
                <div class="modal-title"> Reset All Progress</div>
                <button class="modal-close-btn" onclick="closeResetModal()"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong> Warning!</strong> This action cannot be undone.
                </div>
                <p class="form-text">This will permanently delete:</p>
                <ul style="margin: 12px 0 12px 24px; color: var(--text-light);">
                    <li>All answered questions</li>
                    <li>Correct/incorrect records</li>
                    <li>Flagged questions</li>
                    <li>All statistics</li>
                </ul>
                <p class="form-text" style="margin-top: 16px;">Consider downloading a backup first.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmReset()">Reset Everything</button>
            </div>
        </div>
    </div>

    <!-- Study Planner Modal -->
    <div class="modal" id="study-planner-modal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header-bar">
                <div class="modal-title"> Study Planner</div>
                <button class="modal-close-btn" onclick="closeStudyPlannerModal()"></button>
            </div>
            <div class="modal-body">
                <!-- Mode Selection -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <button class="btn btn-primary mode-btn active" onclick="switchPlannerMode('random')" id="mode-random-btn">
                         Random Review
                    </button>
                    <button class="btn btn-secondary mode-btn" onclick="switchPlannerMode('accuracy')" id="mode-accuracy-btn">
                         Accuracy Boost
                    </button>
                    <button class="btn btn-secondary mode-btn" onclick="switchPlannerMode('weak')" id="mode-weak-btn">
                         Weak Areas
                    </button>
                </div>

                <!-- Random Review Mode -->
                <div id="planner-random-content" class="planner-mode-content">
                    <div class="form-section">
                        <div class="form-label">Number of Questions</div>
                        <p class="form-text">Select random questions from your remaining (unattempted) questions</p>
                        <input type="number" id="random-count" class="form-input" placeholder="e.g., 40" min="1" value="40" style="width: 150px;">
                        <div style="margin-top: 12px; color: var(--text-light); font-size: 14px;" id="random-available-count"></div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generateRandomReview()">Generate Random Test</button>
                    </div>
                    <div id="random-results" style="margin-top: 20px;"></div>
                </div>

                <!-- Accuracy Boost Mode -->
                <div id="planner-accuracy-content" class="planner-mode-content" style="display: none;">
                    <div class="form-section">
                        <div class="form-label">Target Accuracy</div>
                        <p class="form-text">Set your desired accuracy goal. The planner will recommend subtopics to focus on.</p>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="number" id="target-accuracy" class="form-input" placeholder="65" min="0" max="100" value="65" style="width: 100px;">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="form-section">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="prioritize-unattempted" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 14px;">Prioritize unattempted questions</span>
                        </label>
                        <p class="form-text" style="margin-left: 26px;">By default, unattempted questions have low priority. Check this to give them maximum priority.</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generateAccuracyBoost()">Generate Boost Plan</button>
                    </div>
                    <div id="accuracy-results" style="margin-top: 20px;"></div>
                </div>

                <!-- Weak Areas Mode -->
                <div id="planner-weak-content" class="planner-mode-content" style="display: none;">
                    <div class="form-section">
                        <div class="form-label">Accuracy Threshold</div>
                        <p class="form-text">Show only subtopics below this accuracy threshold</p>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <input type="number" id="weak-threshold" class="form-input" placeholder="60" min="0" max="100" value="60" style="width: 100px;">
                            <span>%</span>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generateWeakAreas()">Find Weak Areas</button>
                    </div>
                    <div id="weak-results" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test History Modal -->
    <div class="modal" id="test-history-modal">
        <div class="modal-dialog" style="max-width: 1000px;">
            <div class="modal-header-bar">
                <div class="modal-title"> Test History</div>
                <button class="modal-close-btn" onclick="closeTestHistoryModal()"></button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="show-imported-tests" onchange="renderTestHistory()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 14px;">Show tests from other apps (grouped by date)</span>
                    </label>
                    <p class="form-text" style="margin-left: 26px;">Tests imported from mobile or old backups will be grouped by the date they were attempted.</p>
                </div>
                <div id="test-history-content" style="margin-top: 20px;">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Anki Converter Modal -->
    <div class="modal" id="anki-converter-modal">
        <div class="modal-dialog" style="max-width: 700px;">
            <div class="modal-header-bar">
                <div class="modal-title"> Anki Converter</div>
                <button class="modal-close-btn" onclick="closeAnkiConverterModal()"></button>
            </div>
            <div class="modal-body">
                <!-- Source Selection -->
                <div class="form-section">
                    <div class="form-label">Question Source</div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" id="use-sidebar-btn" onclick="useSidebarQuestions()" style="flex: 1;">
                            Use Sidebar Questions
                        </button>
                        <button class="btn btn-secondary" id="use-custom-btn" onclick="useCustomQuestions()" style="flex: 1;">
                            Paste Question IDs
                        </button>
                    </div>
                    <div id="sidebar-info" style="margin-top: 8px; font-size: 14px; color: var(--text-light);"></div>
                </div>

                <div class="form-section" id="custom-input-section" style="display: none;">
                    <div class="form-label">Question IDs</div>
                    <textarea id="anki-question-ids" class="form-input" placeholder="Enter question IDs (e.g., 2, 3, 4)" style="width: 100%; min-height: 100px; font-family: monospace;"></textarea>
                </div>

                <!-- Deck Selection -->
                <div class="form-section">
                    <div class="form-label">Select Deck</div>
                    <select id="anki-deck" class="form-input" style="width: 100%;">
                        <option value="general">Geral (All Steps)</option>
                        <option value="step1">Step 1</option>
                        <option value="step2ck">Step 2 CK</option>
                        <option value="step3">Step 3</option>
                    </select>
                </div>

                <!-- Version Selection -->
                <div class="form-section">
                    <div class="form-label">AnKing Version</div>
                    <select id="anki-version" class="form-input" style="width: 100%;">
                        <option value="v12">V12</option>
                        <option value="v11">V11</option>
                    </select>
                </div>

                <!-- Generate Button -->
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateAnkiQuery()" style="width: 100%;">Generate Anki Query</button>
                </div>

                <!-- Result -->
                <div id="anki-result" style="margin-top: 20px; display: none;">
                    <div class="form-label">Anki Search Query</div>
                    <textarea readonly id="anki-query-output" style="width: 100%; min-height: 150px; padding: 12px; font-family: monospace; font-size: 12px; border: 1px solid var(--border); border-radius: 8px; background: #f8f9fa;"></textarea>
                    <div style="margin-top: 12px;">
                        <button class="btn btn-primary" onclick="copyAnkiQuery()"> Copy to Clipboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="topics.js"></script>
    <script>
        // State
        let currentSystem = '';
        let currentTopic = '';
        let currentQuestionId = null;

        // Test Mode State
        let isTestMode = false;
        let testQuestions = [];
        let currentTestIndex = 0;

        // Media Zoom State
        let currentZoom = 1;
        let mediaElement = null;

        // Stats Display Mode
        let showPercentages = false;

        // Stats Cache
        let statsCache = null;
        let statsCacheTimestamp = 0;
        const STATS_CACHE_DURATION = 5000; // 5 seconds

        // Password Authentication
        const CORRECT_PASSWORD = 'captain';

        function checkPassword() {
            const passwordInput = document.getElementById('password-input');
            const errorDiv = document.getElementById('login-error');
            const loginScreen = document.getElementById('login-screen');
            const password = passwordInput.value;

            if (password === CORRECT_PASSWORD) {
                // Save authentication status
                localStorage.setItem('authenticated', 'true');

                // Add authenticated class to body to show content
                document.body.classList.add('authenticated');

                // Hide login screen with animation
                loginScreen.style.opacity = '0';
                loginScreen.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    loginScreen.classList.add('hidden');
                    // Load app content after login screen is hidden
                    loadAppContent();
                }, 300);

                // Focus on main content
                errorDiv.textContent = '';
            } else {
                // Show error
                errorDiv.textContent = ' Incorrect password. Please try again.';
                passwordInput.value = '';
                passwordInput.focus();

                // Shake animation
                passwordInput.style.animation = 'shake 0.4s';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                }, 400);
            }
        }

        function checkAuthentication() {
            const isAuthenticated = localStorage.getItem('authenticated') === 'true';
            const loginScreen = document.getElementById('login-screen');

            if (isAuthenticated) {
                // User is authenticated, hide login screen immediately
                document.body.classList.add('authenticated');
                loginScreen.classList.add('hidden');
                return true;
            } else {
                // Focus on password input
                setTimeout(() => {
                    document.getElementById('password-input').focus();
                }, 100);
                return false;
            }
        }

        function loadAppContent() {
            console.log('Loading Q-Bank content...');

            // Load essential UI immediately
            loadSystemFilter();

            // Add keyboard navigation for test mode
            document.addEventListener('keydown', handleKeyPress);

            // Add Enter key support for search
            const searchInput = document.getElementById('question-search');
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startTest();
                }
            });

            // Defer heavy operations to allow UI to render first
            setTimeout(() => {
                renderSystems();
                updateStats();
            }, 50);

            // Restore test state if exists (also deferred)
            setTimeout(() => {
                restoreTestState();
            }, 100);

            console.log('Q-Bank content loaded');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            console.log('Initializing USMLE Env...');

            // Check authentication first - only load content if authenticated
            const isAuthenticated = checkAuthentication();

            if (isAuthenticated) {
                // User is already authenticated, load content immediately
                loadAppContent();
            }
            // If not authenticated, content will be loaded after password is entered

            console.log('Initialization complete');
        }

        // Test State Persistence
        function saveTestState() {
            if (!isTestMode) return;

            const testState = {
                isTestMode: true,
                testQuestions: testQuestions,
                currentTestIndex: currentTestIndex,
                timestamp: Date.now()
            };
            localStorage.setItem('testState', JSON.stringify(testState));
        }

        function restoreTestState() {
            const savedState = localStorage.getItem('testState');
            if (!savedState) return;

            try {
                const testState = JSON.parse(savedState);

                // Check if test is less than 24 hours old
                const hoursSince = (Date.now() - testState.timestamp) / (1000 * 60 * 60);
                if (hoursSince > 24) {
                    localStorage.removeItem('testState');
                    return;
                }

                // Restore test
                if (testState.isTestMode && testState.testQuestions && testState.testQuestions.length > 0) {
                    testQuestions = testState.testQuestions;
                    currentTestIndex = testState.currentTestIndex || 0;

                    // Update search input
                    document.getElementById('question-search').value = testQuestions.join(', ');

                    // Start test without user action
                    isTestMode = true;

                    // Update UI
                    document.getElementById('start-test-btn').style.display = 'none';
                    document.getElementById('finish-test-btn').style.display = 'inline-block';
                    document.getElementById('test-nav-arrows').classList.add('active');
                    document.getElementById('question-search').disabled = true;

                    // Update container
                    const container = document.getElementById('container');
                    container.classList.add('test-mode');
                    document.body.classList.add('test-mode-active');

                    // Render test sidebar
                    renderTestSidebar();

                    // Open current question
                    openTestQuestion(currentTestIndex);
                }
            } catch (e) {
                console.error('Error restoring test state:', e);
                localStorage.removeItem('testState');
            }
        }

        function clearTestState() {
            localStorage.removeItem('testState');
        }

        function handleKeyPress(e) {
            // ESC key closes media modal
            if (e.key === 'Escape') {
                const mediaModal = document.getElementById('media-modal');
                if (mediaModal.classList.contains('show')) {
                    closeMediaModal();
                    e.preventDefault();
                    return;
                }
            }

            if (!isTestMode) return;

            // Left arrow = previous question
            if (e.key === 'ArrowLeft' && currentTestIndex > 0) {
                navigateQuestion(-1);
                e.preventDefault();
            }
            // Right arrow = next question
            else if (e.key === 'ArrowRight' && currentTestIndex < testQuestions.length - 1) {
                navigateQuestion(1);
                e.preventDefault();
            }
        }

        // System Filter
        function loadSystemFilter() {
            const select = document.getElementById('system-filter');
            for (const system in topics) {
                const option = document.createElement('option');
                option.value = system;
                option.textContent = system;
                select.appendChild(option);
            }
            select.onchange = (e) => filterSystems(e.target.value);
        }

        function filterSystems(system) {
            document.querySelectorAll('.system-card').forEach(card => {
                card.style.display = !system || card.dataset.system === system ? 'block' : 'none';
            });
        }

        // Render Systems (optimized with progressive rendering)
        function renderSystems() {
            const container = document.getElementById('systems-list');
            container.innerHTML = '';

            const systemNames = Object.keys(topics);
            let index = 0;

            // Render systems progressively in chunks
            function renderBatch() {
                const batchSize = 3; // Render 3 systems at a time
                const endIndex = Math.min(index + batchSize, systemNames.length);

                for (let i = index; i < endIndex; i++) {
                    const card = createSystemCard(systemNames[i]);
                    container.appendChild(card);
                }

                index = endIndex;

                if (index < systemNames.length) {
                    // Schedule next batch
                    requestAnimationFrame(renderBatch);
                }
            }

            renderBatch();
        }

        function createSystemCard(systemName) {
            const stats = getSystemStats(systemName);
            const card = document.createElement('div');
            card.className = 'system-card';
            card.dataset.system = systemName;

            const sanitizedName = systemName.replace(/'/g, "\\'");

            card.innerHTML = `
                <div class="system-header" onclick="toggleSystem('${sanitizedName}')">
                    <div class="system-name">
                        ${systemName}
                    </div>
                    <div class="system-badge">${stats.completed}/${stats.total}</div>
                </div>
                <div class="topics-list" id="topics-${systemName.replace(/\W/g, '-')}">
                    ${Object.keys(topics[systemName]).map(topic =>
                        createTopicHTML(systemName, topic)
                    ).join('')}
                </div>
            `;

            return card;
        }

        function createTopicHTML(systemName, topicName) {
            const stats = getTopicStats(systemName, topicName);
            const sanitizedSystem = systemName.replace(/'/g, "\\'");
            const sanitizedTopic = topicName.replace(/'/g, "\\'");
            return `
                <div class="topic-item" onclick="loadTopic('${sanitizedSystem}', '${sanitizedTopic}')">
                    <div class="topic-name">
                        ${topicName}
                    </div>
                    <div class="topic-progress">${stats.completed}/${stats.total} completed</div>
                </div>
            `;
        }

        function toggleSystem(systemName) {
            const id = 'topics-' + systemName.replace(/\W/g, '-');
            const list = document.getElementById(id);
            if (list) list.classList.toggle('expanded');
        }

        // Load Topic
        function loadTopic(systemName, topicName) {
            currentSystem = systemName;
            currentTopic = topicName;

            document.querySelectorAll('.topic-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.topic-item').classList.add('active');

            document.getElementById('breadcrumb').textContent = `${systemName}  ${topicName}`;
            document.getElementById('page-title').textContent = topicName;

            renderQuestionsGrid();
        }

        function renderQuestionsGrid() {
            const questionIds = topics[currentSystem][currentTopic];
            const body = document.getElementById('content-body');

            const grid = document.createElement('div');
            grid.className = 'questions-grid';

            questionIds.forEach(qId => {
                const data = getData(qId);
                const card = document.createElement('div');
                card.className = 'question-card';
                card.setAttribute('data-question-id', qId);

                if (data.isCorrect) card.classList.add('correct');
                else if (data.isIncorrect) card.classList.add('incorrect');
                else card.classList.add('unattempted');

                card.innerHTML = `
                    ${data.isFlagged ? '<div class="flag-icon"></div>' : ''}
                    <div class="question-number">${qId}</div>
                    <div class="question-status">
                        ${data.isCorrect ? 'Correct' : data.isIncorrect ? 'Incorrect' : 'New'}
                    </div>
                `;

                card.onclick = () => openQuestion(qId);
                grid.appendChild(card);
            });

            body.innerHTML = '';
            body.appendChild(grid);
        }

        function updateSingleQuestionCard(questionId) {
            // Find the card for this specific question
            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            if (!card) return;

            const data = getData(questionId);

            // Remove all status classes
            card.classList.remove('correct', 'incorrect', 'unattempted');

            // Add new status class
            if (data.isCorrect) card.classList.add('correct');
            else if (data.isIncorrect) card.classList.add('incorrect');
            else card.classList.add('unattempted');

            // Update card content
            card.innerHTML = `
                ${data.isFlagged ? '<div class="flag-icon"></div>' : ''}
                <div class="question-number">${questionId}</div>
                <div class="question-status">
                    ${data.isCorrect ? 'Correct' : data.isIncorrect ? 'Incorrect' : 'New'}
                </div>
            `;

            // Re-attach click handler
            card.onclick = () => openQuestion(questionId);
        }

        // Open Question in Fullscreen (Normal Mode)
        function openQuestion(questionId) {
            currentQuestionId = questionId;
            const data = getData(questionId);

            // Switch to viewing mode
            const container = document.getElementById('container');
            container.classList.add('viewing-question');

            // Show question actions bar
            document.getElementById('question-actions-bar').classList.add('active');

            // Update flag button
            const normalFlagBtn = document.getElementById('normal-flag-btn');
            if (data.isFlagged) {
                normalFlagBtn.classList.add('active');
                normalFlagBtn.textContent = ' Unflag';
            } else {
                normalFlagBtn.classList.remove('active');
                normalFlagBtn.textContent = ' Flag';
            }

            // Update header
            document.getElementById('breadcrumb').textContent = `${currentSystem}  ${currentTopic}  Question ${questionId}`;
            document.getElementById('page-title').textContent = `Question ${questionId}`;

            // Show notes button and set current question ID
            currentNoteQuestionId = questionId;
            document.getElementById('notes-btn').style.display = 'inline-flex';

            // Render topic questions in sidebar
            renderTopicSidebar();

            // Show question in main content area
            const contentBody = document.getElementById('content-body');
            contentBody.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%;">
                    <button class="fullscreen-btn" id="fs-enter-btn" title="Fullscreen (F)"></button>
                    <button class="exit-fullscreen-btn" id="fs-exit-btn" title="Exit Fullscreen (Esc)"></button>
                    <iframe id="question-iframe" src="questions/${questionId}.html" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            `;

            // Add event listeners to fullscreen buttons
            const fsEnterBtn = document.getElementById('fs-enter-btn');
            const fsExitBtn = document.getElementById('fs-exit-btn');
            if (fsEnterBtn) fsEnterBtn.addEventListener('click', enterFullscreen);
            if (fsExitBtn) fsExitBtn.addEventListener('click', exitFullscreen);

            // Update button states based on current question data
            updateActionButtonsState();

            // Setup iframe message handler for media clicks
            setupIframeMediaHandler();

            // Reset the last checked choice for the polling function
            lastCheckedChoice = data.selectedAnswer || '';

            // Reset the last checked result for validation polling
            // Set to empty string so next validation will be detected
            lastCheckedResult = '';

            // Resume timer if it was auto-paused
            if (typeof resumeTimerOnQuestionChange === 'function') {
                resumeTimerOnQuestionChange();
            }
        }

        function closeQuestion() {
            // Exit fullscreen if active
            if (document.body.classList.contains('fullscreen-mode')) {
                exitFullscreen();
            }

            // Exit viewing mode
            const container = document.getElementById('container');
            container.classList.remove('viewing-question');

            // Hide question actions bar
            document.getElementById('question-actions-bar').classList.remove('active');

            // Clear current question
            currentQuestionId = null;

            // Hide notes button
            currentNoteQuestionId = null;
            document.getElementById('notes-btn').style.display = 'none';

            // ALWAYS restore the sidebar with systems/topics first
            const sidebar = document.querySelector('.sidebar');

            // Rebuild the sidebar HTML structure
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div class="sidebar-title">Filter Systems</div>
                    <select class="filter-select" id="system-filter">
                        <option value="">All Systems</option>
                    </select>
                </div>
                <div class="systems-container" id="systems-list"></div>
            `;

            // Repopulate the filter and systems
            loadSystemFilter();
            renderSystems();

            // Update header and content back to topic view
            if (currentSystem && currentTopic) {
                // Update header
                document.getElementById('breadcrumb').textContent = `${currentSystem}  ${currentTopic}`;
                document.getElementById('page-title').textContent = currentTopic;

                // Refresh questions grid
                renderQuestionsGrid();

                // Re-activate the current topic in sidebar after render
                setTimeout(() => {
                    const systemId = 'topics-' + currentSystem.replace(/\W/g, '-');
                    const topicsList = document.getElementById(systemId);
                    if (topicsList) {
                        topicsList.classList.add('expanded');
                    }

                    // Highlight active topic
                    document.querySelectorAll('.topic-item').forEach(item => {
                        const topicText = item.querySelector('.topic-name')?.textContent;
                        if (topicText === currentTopic) {
                            item.classList.add('active');
                        }
                    });
                }, 100);
            } else {
                // No topic selected, show welcome screen
                document.getElementById('breadcrumb').textContent = 'Select a topic to begin';
                document.getElementById('page-title').textContent = 'Welcome to USMLE Env';

                // Show welcome content
                document.getElementById('content-body').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h2>Ready to Study?</h2>
                        <p>Select a system and topic from the sidebar to start practicing questions</p>
                    </div>
                `;
            }
        }

        function markQuestion(status) {
            if (!currentQuestionId) return;

            const data = getData(currentQuestionId);

            if (status === 'correct') {
                data.isCorrect = true;
                data.isIncorrect = false;
            } else if (status === 'incorrect') {
                data.isIncorrect = true;
                data.isCorrect = false;
            }

            data.attempts = (data.attempts || 0) + 1;
            data.lastAttempted = new Date().toISOString().split('T')[0];

            saveData(currentQuestionId, data);

            // Update button visual state
            updateActionButtonsState();

            // Invalidate stats cache
            statsCache = null;
            updateStats();

            // Refresh current view
            if (isTestMode) {
                // Update test sidebar to show new status
                renderTestSidebar();
                // Scroll to active question
                setTimeout(() => {
                    const activeItem = document.querySelector('.test-question-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            } else {
                const container = document.getElementById('container');
                if (container.classList.contains('viewing-question')) {
                    // We're in normal question viewing mode
                    renderTopicSidebar();
                } else if (currentSystem && currentTopic) {
                    // We're in grid view
                    renderQuestionsGrid();
                    renderSystems();
                }
            }
        }

        function updateActionButtonsState() {
            if (!currentQuestionId) return;

            const data = getData(currentQuestionId);

            // Update test mode buttons
            const testCorrectBtn = document.querySelector('.test-actions-bar .btn-correct');
            const testIncorrectBtn = document.querySelector('.test-actions-bar .btn-incorrect');

            if (testCorrectBtn && testIncorrectBtn) {
                testCorrectBtn.classList.toggle('selected', data.isCorrect);
                testIncorrectBtn.classList.toggle('selected', data.isIncorrect);
            }

            // Update normal mode buttons
            const normalCorrectBtn = document.querySelector('.question-actions-bar .btn-correct');
            const normalIncorrectBtn = document.querySelector('.question-actions-bar .btn-incorrect');

            if (normalCorrectBtn && normalIncorrectBtn) {
                normalCorrectBtn.classList.toggle('selected', data.isCorrect);
                normalIncorrectBtn.classList.toggle('selected', data.isIncorrect);
            }

            // Update answer dropdowns
            updateAnswerDropdowns();
        }

        function updateAnswerDropdowns() {
            if (!currentQuestionId) return;

            const data = getData(currentQuestionId);
            const testSelect = document.getElementById('test-answer-select');
            const normalSelect = document.getElementById('normal-answer-select');

            if (testSelect) {
                testSelect.value = data.selectedAnswer || '';
            }
            if (normalSelect) {
                normalSelect.value = data.selectedAnswer || '';
            }
        }

        function saveSelectedAnswer() {
            if (!currentQuestionId) return;

            const data = getData(currentQuestionId);

            // Get value from whichever dropdown is visible
            const testSelect = document.getElementById('test-answer-select');
            const normalSelect = document.getElementById('normal-answer-select');

            if (isTestMode && testSelect) {
                data.selectedAnswer = testSelect.value;
            } else if (normalSelect) {
                data.selectedAnswer = normalSelect.value;
            }

            saveData(currentQuestionId, data);

            // Sync both dropdowns
            updateAnswerDropdowns();

            // Also save to the choice_q format that iframe uses
            const choiceKey = 'choice_q' + currentQuestionId;
            if (data.selectedAnswer) {
                localStorage.setItem(choiceKey, data.selectedAnswer);
            } else {
                localStorage.removeItem(choiceKey);
            }

            // Update lastCheckedChoice to prevent loop
            lastCheckedChoice = data.selectedAnswer;
        }

        // Check for choice changes in iframe (using localStorage polling)
        let lastCheckedChoice = '';

        function checkIframeChoice() {
            if (!currentQuestionId) return;

            const choiceKey = 'choice_q' + currentQuestionId;
            const currentChoice = localStorage.getItem(choiceKey) || '';

            if (currentChoice && currentChoice !== lastCheckedChoice) {
                lastCheckedChoice = currentChoice;

                const testSelect = document.getElementById('test-answer-select');
                const normalSelect = document.getElementById('normal-answer-select');

                // Update both dropdowns
                if (testSelect && testSelect.value !== currentChoice) {
                    testSelect.value = currentChoice;
                }
                if (normalSelect && normalSelect.value !== currentChoice) {
                    normalSelect.value = currentChoice;
                }

                // Save to our data structure
                const data = getData(currentQuestionId);
                data.selectedAnswer = currentChoice;
                saveData(currentQuestionId, data);
            }
        }

        // Check every 500ms for changes
        setInterval(checkIframeChoice, 500);

        // Check for answer validation from iframe
        let lastCheckedResult = '';

        function checkAnswerValidation() {
            if (!currentQuestionId) return;

            const resultKey = 'result_q' + currentQuestionId;
            const currentResult = localStorage.getItem(resultKey) || '';

            if (currentResult && currentResult !== lastCheckedResult) {
                lastCheckedResult = currentResult;

                // Auto-mark correct or incorrect
                const data = getData(currentQuestionId);

                if (currentResult === 'correct') {
                    data.isCorrect = true;
                    data.isIncorrect = false;
                } else if (currentResult === 'incorrect') {
                    data.isCorrect = false;
                    data.isIncorrect = true;
                }

                saveData(currentQuestionId, data);

                // Update button UI
                updateActionButtonsState();

                // Update stats display
                updateStats();

                // Update sidebar/grid based on mode
                if (isTestMode) {
                    // Update test mode sidebar item
                    updateSingleTestQuestionItem(currentQuestionId);
                } else {
                    // Check if we're viewing a question (sidebar shows topic questions)
                    const container = document.getElementById('container');
                    if (container && container.classList.contains('viewing-question')) {
                        // Update topic sidebar item
                        updateSingleTopicSidebarItem(currentQuestionId);
                    } else {
                        // Update normal mode question card in grid
                        updateSingleQuestionCard(currentQuestionId);
                    }
                }

                console.log(`Auto-marked as ${currentResult} for question ${currentQuestionId}`);
            }
        }

        // Check every 500ms for answer validation
        setInterval(checkAnswerValidation, 500);

        function toggleFlag() {
            if (!currentQuestionId) return;

            const data = getData(currentQuestionId);
            data.isFlagged = !data.isFlagged;
            saveData(currentQuestionId, data);

            // Update flag buttons (test mode and normal mode)
            const testFlagBtn = document.getElementById('test-flag-btn');
            const normalFlagBtn = document.getElementById('normal-flag-btn');

            if (data.isFlagged) {
                if (testFlagBtn) {
                    testFlagBtn.classList.add('active');
                    testFlagBtn.textContent = ' Unflag';
                }
                if (normalFlagBtn) {
                    normalFlagBtn.classList.add('active');
                    normalFlagBtn.textContent = ' Unflag';
                }
            } else {
                if (testFlagBtn) {
                    testFlagBtn.classList.remove('active');
                    testFlagBtn.textContent = ' Flag';
                }
                if (normalFlagBtn) {
                    normalFlagBtn.classList.remove('active');
                    normalFlagBtn.textContent = ' Flag';
                }
            }

            // Refresh views
            if (isTestMode) {
                renderTestSidebar();
            } else {
                const container = document.getElementById('container');
                if (container.classList.contains('viewing-question')) {
                    renderTopicSidebar();
                } else if (currentSystem && currentTopic) {
                    renderQuestionsGrid();
                    renderSystems();
                }
            }
        }

        // Test Mode Functions
        // Validate question IDs against topics.js
        function validateQuestionIds(questionIds) {
            if (!topics) {
                return { valid: [], invalid: questionIds };
            }

            const allQuestionIds = new Set();

            // Collect all question IDs from topics
            for (const system in topics) {
                for (const category in topics[system]) {
                    const questions = topics[system][category];
                    if (Array.isArray(questions)) {
                        questions.forEach(id => allQuestionIds.add(String(id)));
                    }
                }
            }

            const valid = [];
            const invalid = [];

            questionIds.forEach(id => {
                if (allQuestionIds.has(String(id))) {
                    valid.push(id);
                } else {
                    invalid.push(id);
                }
            });

            return { valid, invalid };
        }

        // Handle Search - Only IDs
        function handleSearch() {
            const input = document.getElementById('question-search');
            const searchTerm = input.value.trim();

            if (!searchTerm) {
                alert('Please enter question IDs (e.g., 174, 556, 892)');
                return;
            }

            // Check if search term contains only numbers, commas, and spaces (question IDs)
            const isNumericSearch = /^[\d,\s]+$/.test(searchTerm);

            if (!isNumericSearch) {
                alert('Please enter only question IDs separated by commas (e.g., 174, 556, 892)');
                return;
            }

            // Start test with question IDs
            startTest();
        }

        function startTest() {
            const input = document.getElementById('question-search');
            const idsString = input.value.trim();

            if (!idsString) {
                alert('Please enter question IDs (e.g., 174, 556, 789)');
                return;
            }

            // Parse question IDs
            const parsedIds = idsString
                .split(/[,\s]+/)
                .map(id => id.trim())
                .filter(id => id !== '');

            if (parsedIds.length === 0) {
                alert('Please enter valid question IDs');
                return;
            }

            // Validate question IDs
            const { valid, invalid } = validateQuestionIds(parsedIds);

            if (invalid.length > 0) {
                const invalidList = invalid.join(', ');
                const message = valid.length > 0
                    ? `Invalid Question IDs found: ${invalidList}\n\n${valid.length} valid question(s) found.\n\nContinue with valid questions only?`
                    : `Invalid Question IDs found: ${invalidList}\n\nNo valid questions found. Please check your IDs.`;

                if (valid.length > 0) {
                    if (confirm(message)) {
                        testQuestions = valid;
                    } else {
                        return;
                    }
                } else {
                    alert(message);
                    return;
                }
            } else {
                testQuestions = valid;
            }

            // Enter test mode
            isTestMode = true;
            currentTestIndex = 0;

            // Update UI
            document.getElementById('start-test-btn').style.display = 'none';
            document.getElementById('finish-test-btn').style.display = 'inline-block';
            document.getElementById('test-nav-arrows').classList.add('active');
            document.getElementById('question-search').disabled = true;

            // Update container and sidebar
            const container = document.getElementById('container');
            const sidebar = document.querySelector('.sidebar');
            container.classList.add('test-mode');
            document.body.classList.add('test-mode-active');

            // Auto-start stopwatch and enable auto-pause
            stopStopwatch(); // Reset stopwatch first
            const autoPauseCheckbox = document.getElementById('autoPauseOnSubmit');
            autoPauseCheckbox.checked = true;
            localStorage.setItem('autoPauseOnSubmit', 'true');
            startStopwatch(); // Start automatically

            // Render test sidebar
            renderTestSidebar();

            // Open first question in fullscreen
            openTestQuestion(currentTestIndex);

            // Save test state
            saveTestState();

            // Save to test history
            saveTestToHistory(testQuestions);
        }

        function finishTest() {
            if (!confirm('Are you sure you want to finish this test?')) {
                return;
            }

            // Update test time in history before finishing
            updateTestTimeInHistory();

            // Pause stopwatch if it's running
            if (stopwatchState === 'running') {
                pauseStopwatch();
            }

            // Exit fullscreen if active
            if (document.body.classList.contains('fullscreen-mode')) {
                exitFullscreen();
            }

            // Clear test state
            clearTestState();

            // Exit test mode
            isTestMode = false;
            testQuestions = [];
            currentTestIndex = 0;

            // Update UI - hide test mode buttons
            document.getElementById('start-test-btn').style.display = 'inline-block';
            document.getElementById('finish-test-btn').style.display = 'none';
            document.getElementById('test-nav-arrows').classList.remove('active');
            document.getElementById('question-actions-bar').classList.remove('active');
            document.getElementById('question-search').disabled = false;
            document.getElementById('question-search').value = '';

            // Exit viewing mode
            const container = document.getElementById('container');
            container.classList.remove('test-mode');
            container.classList.remove('viewing-question');
            document.body.classList.remove('test-mode-active');

            // Clear current question
            currentQuestionId = null;

            // Hide notes button
            currentNoteQuestionId = null;
            document.getElementById('notes-btn').style.display = 'none';

            // ALWAYS restore the sidebar with systems/topics
            const sidebar = document.querySelector('.sidebar');

            // Rebuild the sidebar HTML structure
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div class="sidebar-title">Filter Systems</div>
                    <select class="filter-select" id="system-filter">
                        <option value="">All Systems</option>
                    </select>
                </div>
                <div class="systems-container" id="systems-list"></div>
            `;

            // Repopulate the filter and systems
            loadSystemFilter();
            renderSystems();

            // Show welcome screen
            document.getElementById('breadcrumb').textContent = 'Select a topic to begin';
            document.getElementById('page-title').textContent = 'Welcome to USMLE Env';
            document.getElementById('content-body').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon"></div>
                    <h2>Ready to Study?</h2>
                    <p>Select a system and topic from the sidebar to start practicing questions</p>
                </div>
            `;

            // Clear any stored currentSystem/currentTopic
            currentSystem = '';
            currentTopic = '';
        }

        function renderTestSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.add('test-mode');
            sidebar.innerHTML = `
                <div class="test-sidebar-header">
                    <div class="test-sidebar-title">Test Mode</div>
                    <div class="test-sidebar-info">${testQuestions.length} Questions</div>
                </div>
                <div class="test-questions-list" id="test-questions-list">
                    ${testQuestions.map((qId, index) => {
                        const data = getData(qId);
                        const statusIcons = [];
                        if (data.isFlagged) statusIcons.push('');
                        if (data.isCorrect) statusIcons.push('');
                        if (data.isIncorrect) statusIcons.push('');

                        return `
                            <div class="test-question-item ${index === currentTestIndex ? 'active' : ''}"
                                 onclick="openTestQuestion(${index})"
                                 data-index="${index}"
                                 data-question-id="${qId}">
                                <div class="test-question-number">Q ${qId}</div>
                                <div class="test-question-status">${statusIcons.join(' ')}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updateSingleTestQuestionItem(questionId) {
            // Find the test question item for this specific question
            const item = document.querySelector(`.test-question-item[data-question-id="${questionId}"]`);
            if (!item) return;

            const data = getData(questionId);
            const statusIcons = [];
            if (data.isFlagged) statusIcons.push('');
            if (data.isCorrect) statusIcons.push('');
            if (data.isIncorrect) statusIcons.push('');

            // Update only the status part
            const statusElement = item.querySelector('.test-question-status');
            if (statusElement) {
                statusElement.textContent = statusIcons.join(' ');
            }
        }

        function openTestQuestion(index) {
            currentTestIndex = index;
            const questionId = testQuestions[index];

            // Update active state in sidebar
            document.querySelectorAll('.test-question-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                    // Scroll active item into view smoothly
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });

            // Update navigation buttons
            document.getElementById('prev-btn').disabled = index === 0;
            document.getElementById('next-btn').disabled = index === testQuestions.length - 1;

            // Open question in fullscreen
            currentQuestionId = questionId;
            const data = getData(questionId);

            // Show test actions bar
            document.getElementById('test-actions-bar').classList.add('active');

            // Update flag button in test actions bar
            const testFlagBtn = document.getElementById('test-flag-btn');
            if (data.isFlagged) {
                testFlagBtn.classList.add('active');
                testFlagBtn.textContent = ' Unflag';
            } else {
                testFlagBtn.classList.remove('active');
                testFlagBtn.textContent = ' Flag';
            }

            // Update content area to show question
            document.getElementById('breadcrumb').textContent = `Test Mode - Question ${index + 1} of ${testQuestions.length}`;
            document.getElementById('page-title').textContent = `Question ${questionId}`;

            // Show notes button and set current question ID
            currentNoteQuestionId = questionId;
            document.getElementById('notes-btn').style.display = 'inline-flex';

            // Show question in main content area (fullscreen)
            const contentBody = document.getElementById('content-body');
            contentBody.innerHTML = `
                <div style="position: relative; width: 100%; height: 100%;">
                    <button class="fullscreen-btn" id="fs-enter-btn" title="Fullscreen (F)"></button>
                    <button class="exit-fullscreen-btn" id="fs-exit-btn" title="Exit Fullscreen (Esc)"></button>
                    <iframe id="question-iframe" src="questions/${questionId}.html" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            `;

            // Add event listeners to fullscreen buttons
            const fsEnterBtn = document.getElementById('fs-enter-btn');
            const fsExitBtn = document.getElementById('fs-exit-btn');
            if (fsEnterBtn) fsEnterBtn.addEventListener('click', enterFullscreen);
            if (fsExitBtn) fsExitBtn.addEventListener('click', exitFullscreen);

            // Update button states based on current question data
            updateActionButtonsState();

            // Setup iframe media handler
            setupIframeMediaHandler();

            // Reset the last checked choice for the polling function
            lastCheckedChoice = data.selectedAnswer || '';

            // Reset the last checked result for validation polling
            // Set to empty string so next validation will be detected
            lastCheckedResult = '';

            // Resume timer if it was auto-paused
            if (typeof resumeTimerOnQuestionChange === 'function') {
                resumeTimerOnQuestionChange();
            }
        }

        function navigateQuestion(direction) {
            const newIndex = currentTestIndex + direction;
            if (newIndex >= 0 && newIndex < testQuestions.length) {
                openTestQuestion(newIndex);
                saveTestState();
            }
        }

        // Data Management
        function getData(qId) {
            const all = JSON.parse(localStorage.getItem('questionData') || '{}');
            return all[qId] || {
                isCorrect: false,
                isIncorrect: false,
                isFlagged: false,
                attempts: 0,
                selectedAnswer: ''
            };
        }

        function saveData(qId, data) {
            const all = JSON.parse(localStorage.getItem('questionData') || '{}');
            all[qId] = data;
            localStorage.setItem('questionData', JSON.stringify(all));
        }

        // Statistics
        function getTopicStats(systemName, topicName) {
            const qIds = topics[systemName][topicName];
            let total = qIds.length;
            let correct = 0;
            let incorrect = 0;
            let flagged = 0;
            let completed = 0;

            qIds.forEach(qId => {
                const data = getData(qId);
                if (data.isCorrect) correct++;
                if (data.isIncorrect) incorrect++;
                if (data.isFlagged) flagged++;
                if (data.isCorrect || data.isIncorrect) completed++;
            });

            const attempted = correct + incorrect;
            const accuracy = attempted > 0 ? ((correct / attempted) * 100).toFixed(1) : 0;

            return { total, correct, incorrect, flagged, completed, attempted, accuracy };
        }

        function getSystemStats(systemName) {
            let total = 0, correct = 0, incorrect = 0, flagged = 0, completed = 0;

            for (const topic in topics[systemName]) {
                const stats = getTopicStats(systemName, topic);
                total += stats.total;
                correct += stats.correct;
                incorrect += stats.incorrect;
                flagged += stats.flagged;
                completed += stats.completed;
            }

            const attempted = correct + incorrect;
            const accuracy = attempted > 0 ? ((correct / attempted) * 100).toFixed(1) : 0;

            return { total, correct, incorrect, flagged, completed, attempted, accuracy };
        }

        function updateStats(forceRecalculate = false) {
            // Check cache validity
            const now = Date.now();
            if (!forceRecalculate && statsCache && (now - statsCacheTimestamp) < STATS_CACHE_DURATION) {
                // Use cached stats
                const { totalQuestions, correct, incorrect, attempted, remaining, accuracy } = statsCache;
                displayStats(totalQuestions, correct, incorrect, attempted, remaining, accuracy);
                return;
            }

            // Recalculate stats
            let totalQuestions = 0, correct = 0, incorrect = 0;

            for (const system in topics) {
                for (const topic in topics[system]) {
                    topics[system][topic].forEach(qId => {
                        totalQuestions++;
                        const data = getData(qId);
                        if (data.isCorrect) correct++;
                        if (data.isIncorrect) incorrect++;
                    });
                }
            }

            const attempted = correct + incorrect;
            const remaining = totalQuestions - attempted;
            const accuracy = attempted > 0 ? ((correct / attempted) * 100).toFixed(1) : 0;

            // Cache the results
            statsCache = { totalQuestions, correct, incorrect, attempted, remaining, accuracy };
            statsCacheTimestamp = now;

            displayStats(totalQuestions, correct, incorrect, attempted, remaining, accuracy);
        }

        function displayStats(totalQuestions, correct, incorrect, attempted, remaining, accuracy) {

            if (showPercentages) {
                // Show as percentages
                const totalPct = totalQuestions > 0 ? ((attempted / totalQuestions) * 100).toFixed(1) : 0;
                const correctPct = attempted > 0 ? ((correct / attempted) * 100).toFixed(1) : 0;
                const incorrectPct = attempted > 0 ? ((incorrect / attempted) * 100).toFixed(1) : 0;
                const remainingPct = totalQuestions > 0 ? ((remaining / totalQuestions) * 100).toFixed(1) : 100;

                document.getElementById('stat-total').textContent = totalPct + '%';
                document.getElementById('stat-correct').textContent = correctPct + '%';
                document.getElementById('stat-incorrect').textContent = incorrectPct + '%';
                document.getElementById('stat-remaining').textContent = remainingPct + '%';
            } else {
                // Show as absolute numbers
                document.getElementById('stat-total').textContent = attempted;
                document.getElementById('stat-correct').textContent = correct;
                document.getElementById('stat-incorrect').textContent = incorrect;
                document.getElementById('stat-remaining').textContent = remaining;
            }

            // Accuracy always shows percentage
            document.getElementById('stat-accuracy').textContent = attempted > 0 ? accuracy + '%' : 'N/A';
        }

        function toggleStatsDisplay() {
            showPercentages = !showPercentages;
            updateStats();
        }

        // Statistics Modal (detailed by topic)
        function openStatsModal() {
            const modal = document.getElementById('stats-modal');
            const body = document.getElementById('stats-modal-body');

            let html = '';

            // Add overall magnifying glass at the top
            html += `
                <div class="overall-ids-section">
                    <button class="ids-magnify-btn" onclick="showOverallQuestionIds()" title="View all question IDs">
                         View All Question IDs
                    </button>
                </div>
            `;

            for (const system in topics) {
                const systemStats = getSystemStats(system);
                const sanitizedSystem = system.replace(/'/g, "\\'");

                html += `
                    <div class="system-stats-section">
                        <div class="system-stats-header">
                            <div class="system-stats-title">
                                ${system}
                                <span class="magnify-icon-inline" onclick="event.stopPropagation(); showSystemQuestionIds('${sanitizedSystem}')" title="View question IDs"></span>
                            </div>
                            <div class="system-stats-summary">
                                ${systemStats.accuracy}% accuracy |
                                ${systemStats.attempted}/${systemStats.total} attempted
                                ${systemStats.flagged > 0 ? ` |  ${systemStats.flagged} flagged` : ''}
                            </div>
                        </div>
                        <div class="topic-stats-grid">
                `;

                for (const topic in topics[system]) {
                    const topicStats = getTopicStats(system, topic);
                    const progressPct = topicStats.total > 0 ? (topicStats.attempted / topicStats.total * 100).toFixed(0) : 0;
                    const sanitizedTopic = topic.replace(/'/g, "\\'");

                    html += `
                        <div class="topic-stat-card">
                            <div class="topic-stat-name">
                                ${topic}
                                <span class="magnify-icon-inline" onclick="event.stopPropagation(); showTopicQuestionIds('${sanitizedSystem}', '${sanitizedTopic}')" title="View question IDs"></span>
                            </div>
                            <div class="topic-stat-detail">
                                <strong>${topicStats.accuracy}%</strong> accuracy<br>
                                 ${topicStats.correct} correct |  ${topicStats.incorrect} incorrect<br>
                                ${topicStats.attempted}/${topicStats.total} attempted
                                ${topicStats.flagged > 0 ? ` |  ${topicStats.flagged}` : ''}
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPct}%"></div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            body.innerHTML = html;
            modal.classList.add('show');
        }

        function closeStatsModal() {
            document.getElementById('stats-modal').classList.remove('show');
        }

        // Progress Chart Modal
        let progressChart = null;

        function openProgressChartModal() {
            const modal = document.getElementById('progress-chart-modal');
            modal.classList.add('show');

            // Populate system filter
            const systemFilter = document.getElementById('chart-system-filter');
            systemFilter.innerHTML = '<option value="">All Systems</option>';
            Object.keys(topics).forEach(system => {
                const option = document.createElement('option');
                option.value = system;
                option.textContent = system;
                systemFilter.appendChild(option);
            });

            updateProgressChart();
        }

        function closeProgressChartModal() {
            document.getElementById('progress-chart-modal').classList.remove('show');
            if (progressChart) {
                progressChart.destroy();
                progressChart = null;
            }
        }

        function updateProgressChart() {
            const metric = document.getElementById('chart-metric-filter').value;
            const systemFilterContainer = document.getElementById('chart-system-filter').parentElement;
            const selectedSystem = document.getElementById('chart-system-filter').value;
            const period = document.getElementById('chart-period-filter').value;
            const chartType = document.getElementById('chart-type-filter').value;

            // Hide system filter for time metrics
            if (metric === 'totalTime' || metric === 'avgTime') {
                systemFilterContainer.style.display = 'none';
            } else {
                systemFilterContainer.style.display = 'block';
            }

            // Get all question data with lastAttempted dates
            const questionData = JSON.parse(localStorage.getItem('questionData') || '{}');
            const testHistory = JSON.parse(localStorage.getItem('testHistory') || '[]');
            const dailyStats = {};

            // Process data - aggregate by day first
            for (const system in topics) {
                if (selectedSystem && system !== selectedSystem) continue;

                for (const topic in topics[system]) {
                    topics[system][topic].forEach(qId => {
                        const data = questionData[qId];
                        if (!data || !data.lastAttempted) return;

                        const date = data.lastAttempted; // Already in YYYY-MM-DD format

                        if (!dailyStats[date]) {
                            dailyStats[date] = { total: 0, correct: 0, incorrect: 0, marked: 0, totalTime: 0, questionCount: 0 };
                        }

                        if (data.isCorrect || data.isIncorrect) {
                            dailyStats[date].total++;
                        }
                        if (data.isCorrect) dailyStats[date].correct++;
                        if (data.isIncorrect) dailyStats[date].incorrect++;
                        if (data.isFlagged) dailyStats[date].marked++;
                    });
                }
            }

            // Add time data from test history
            // Time metrics are NOT filtered by system - always show total time for all tests
            testHistory.forEach(test => {
                const dateStr = test.date.split('T')[0]; // Get YYYY-MM-DD from ISO string

                if (!dailyStats[dateStr]) {
                    dailyStats[dateStr] = { total: 0, correct: 0, incorrect: 0, marked: 0, totalTime: 0, questionCount: 0 };
                }

                // Always add total time regardless of system filter
                dailyStats[dateStr].totalTime += test.totalTime || 0;
                dailyStats[dateStr].questionCount += test.questionCount || 0;
            });

            // Group data by period
            const periodStats = {};
            const sortedDates = Object.keys(dailyStats).sort();

            sortedDates.forEach(dateStr => {
                const date = new Date(dateStr + 'T00:00:00');
                let periodKey;

                if (period === 'day') {
                    periodKey = dateStr; // YYYY-MM-DD
                } else if (period === 'week') {
                    // Get week start (Monday)
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
                    const weekStart = new Date(date.setDate(diff));
                    periodKey = weekStart.toISOString().split('T')[0];
                } else if (period === 'month') {
                    periodKey = dateStr.substring(0, 7); // YYYY-MM
                }

                if (!periodStats[periodKey]) {
                    periodStats[periodKey] = { total: 0, correct: 0, incorrect: 0, marked: 0, totalTime: 0, questionCount: 0 };
                }

                periodStats[periodKey].total += dailyStats[dateStr].total;
                periodStats[periodKey].correct += dailyStats[dateStr].correct;
                periodStats[periodKey].incorrect += dailyStats[dateStr].incorrect;
                periodStats[periodKey].marked += dailyStats[dateStr].marked;
                periodStats[periodKey].totalTime += dailyStats[dateStr].totalTime;
                periodStats[periodKey].questionCount += dailyStats[dateStr].questionCount;
            });

            // Prepare chart data (NON-CUMULATIVE)
            const labels = Object.keys(periodStats).sort();
            const data = labels.map(label => {
                const stats = periodStats[label];

                if (metric === 'accuracy') {
                    const attempted = stats.correct + stats.incorrect;
                    return attempted > 0 ? ((stats.correct / attempted) * 100).toFixed(1) : 0;
                } else if (metric === 'totalTime') {
                    // Convert from milliseconds to minutes
                    return (stats.totalTime / 60000).toFixed(1);
                } else if (metric === 'avgTime') {
                    // Convert from milliseconds to seconds
                    const avgMs = stats.questionCount > 0 ? stats.totalTime / stats.questionCount : 0;
                    return (avgMs / 1000).toFixed(1);
                }
                return stats[metric];
            });

            // Create/update chart
            const ctx = document.getElementById('progress-chart').getContext('2d');

            if (progressChart) {
                progressChart.destroy();
            }

            // Format labels based on period
            const formattedLabels = labels.map(label => {
                if (period === 'day') {
                    const date = new Date(label + 'T00:00:00');
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else if (period === 'week') {
                    const date = new Date(label + 'T00:00:00');
                    return 'Week of ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else if (period === 'month') {
                    const [year, month] = label.split('-');
                    const date = new Date(year, month - 1);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                }
                return label;
            });

            // Define colors for each metric
            const metricColors = {
                total: {
                    bg: 'rgba(26, 115, 232, 0.7)',    // Blue
                    border: '#1a73e8'
                },
                correct: {
                    bg: 'rgba(52, 168, 83, 0.7)',     // Green
                    border: '#34a853'
                },
                incorrect: {
                    bg: 'rgba(234, 67, 53, 0.7)',     // Red
                    border: '#ea4335'
                },
                marked: {
                    bg: 'rgba(251, 188, 5, 0.7)',     // Yellow/Orange
                    border: '#fbbc05'
                },
                accuracy: {
                    bg: 'rgba(156, 39, 176, 0.7)',    // Purple
                    border: '#9c27b0'
                },
                totalTime: {
                    bg: 'rgba(255, 112, 67, 0.7)',    // Orange
                    border: '#ff7043'
                },
                avgTime: {
                    bg: 'rgba(0, 188, 212, 0.7)',     // Cyan
                    border: '#00bcd4'
                }
            };

            const colors = metricColors[metric];

            progressChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: document.getElementById('chart-metric-filter').selectedOptions[0].text + ' per ' + period,
                        data: data,
                        backgroundColor: colors.bg,
                        borderColor: colors.border,
                        borderWidth: 2,
                        fill: true,  // Always fill area below the line
                        tension: 0.4,  // Smooth curve
                        pointRadius: chartType === 'line' ? 4 : 0,
                        pointHoverRadius: chartType === 'line' ? 6 : 0,
                        pointBackgroundColor: colors.border,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (metric === 'accuracy') {
                                        label += context.parsed.y + '%';
                                    } else {
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: metric === 'accuracy' ? 100 : undefined,
                            ticks: {
                                precision: 0,
                                callback: function(value) {
                                    return metric === 'accuracy' ? value + '%' : value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Heatmap Modal
        let currentHeatmapYear = new Date().getFullYear();

        function openHeatmapModal() {
            const modal = document.getElementById('heatmap-modal');
            modal.classList.add('show');
            currentHeatmapYear = new Date().getFullYear();
            renderHeatmap();
        }

        function closeHeatmapModal() {
            document.getElementById('heatmap-modal').classList.remove('show');
        }

        function changeHeatmapYear(delta) {
            currentHeatmapYear += delta;
            document.getElementById('heatmap-year').textContent = currentHeatmapYear;
            renderHeatmap();
        }

        function getHeatmapColor(count) {
            if (count === 0) return '#ebedf0';
            if (count <= 5) return '#9be9a8';
            if (count <= 10) return '#40c463';
            if (count <= 20) return '#30a14e';
            return '#216e39';
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap-container');
            const questionData = JSON.parse(localStorage.getItem('questionData') || '{}');
            const testHistory = JSON.parse(localStorage.getItem('testHistory') || '[]');

            // Aggregate data by date
            const dailyActivity = {};

            for (const qId in questionData) {
                const data = questionData[qId];
                if (!data.lastAttempted) continue;

                const dateStr = data.lastAttempted; // Already in YYYY-MM-DD format
                const date = new Date(dateStr + 'T00:00:00');
                if (date.getFullYear() !== currentHeatmapYear) continue;

                if (!dailyActivity[dateStr]) {
                    dailyActivity[dateStr] = { total: 0, correct: 0, incorrect: 0, marked: 0, totalTime: 0 };
                }

                if (data.isCorrect || data.isIncorrect) {
                    dailyActivity[dateStr].total++;
                }
                if (data.isCorrect) dailyActivity[dateStr].correct++;
                if (data.isIncorrect) dailyActivity[dateStr].incorrect++;
                if (data.isFlagged) dailyActivity[dateStr].marked++;
            }

            // Add time data from test history
            testHistory.forEach(test => {
                const dateStr = test.date.split('T')[0]; // Get YYYY-MM-DD from ISO string
                const date = new Date(dateStr + 'T00:00:00');
                if (date.getFullYear() !== currentHeatmapYear) return;

                if (!dailyActivity[dateStr]) {
                    dailyActivity[dateStr] = { total: 0, correct: 0, incorrect: 0, marked: 0, totalTime: 0 };
                }

                dailyActivity[dateStr].totalTime += test.totalTime || 0;
            });

            // Build heatmap grid
            const startDate = new Date(currentHeatmapYear, 0, 1);
            const endDate = new Date(currentHeatmapYear, 11, 31);

            // Adjust to start on Sunday
            const startDay = startDate.getDay();
            const adjustedStart = new Date(startDate);
            adjustedStart.setDate(startDate.getDate() - startDay);

            let html = '<div class="heatmap-grid">';

            // Month labels
            html += '<div class="heatmap-months">';
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let currentMonth = -1;
            let weekCount = 0;

            for (let d = new Date(adjustedStart); d <= endDate; d.setDate(d.getDate() + 7)) {
                const month = d.getMonth();
                if (month !== currentMonth && d >= startDate) {
                    html += `<div class="heatmap-month">${months[month]}</div>`;
                    currentMonth = month;
                }
                weekCount++;
            }
            html += '</div>';

            // Grid body
            html += '<div class="heatmap-body">';
            html += '<div class="heatmap-days-labels"><div>Mon</div><div>Wed</div><div>Fri</div></div>';
            html += '<div class="heatmap-weeks">';

            const currentDate = new Date(adjustedStart);
            while (currentDate <= endDate) {
                html += '<div class="heatmap-week">';

                for (let day = 0; day < 7; day++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const activity = dailyActivity[dateStr] || { total: 0, correct: 0, incorrect: 0, marked: 0, totalTime: 0 };
                    const color = getHeatmapColor(activity.total);

                    const isCurrentYear = currentDate.getFullYear() === currentHeatmapYear;
                    const opacity = isCurrentYear ? 1 : 0.3;

                    html += `<div class="heatmap-day"
                        style="background: ${color}; opacity: ${opacity};"
                        onmouseenter="showHeatmapTooltip(event, '${dateStr}', ${activity.total}, ${activity.correct}, ${activity.incorrect}, ${activity.marked}, ${activity.totalTime})"
                        onmouseleave="hideHeatmapTooltip()"
                    ></div>`;

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                html += '</div>';
            }

            html += '</div></div></div>';
            container.innerHTML = html;
        }

        let heatmapTooltip = null;

        function showHeatmapTooltip(event, date, total, correct, incorrect, marked, totalTime) {
            if (!heatmapTooltip) {
                heatmapTooltip = document.createElement('div');
                heatmapTooltip.className = 'heatmap-tooltip';
                document.body.appendChild(heatmapTooltip);
            }

            const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            // Format time
            const totalMinutes = Math.floor(totalTime / 60000);
            const totalSeconds = Math.floor((totalTime % 60000) / 1000);
            const timeStr = totalTime > 0 ? `${totalMinutes}m ${totalSeconds}s` : '0m 0s';

            heatmapTooltip.innerHTML = `
                <div class="heatmap-tooltip-date">${formattedDate}</div>
                <div class="heatmap-tooltip-stat">Total: ${total}</div>
                <div class="heatmap-tooltip-stat">Correct: ${correct}</div>
                <div class="heatmap-tooltip-stat">Incorrect: ${incorrect}</div>
                <div class="heatmap-tooltip-stat">Marked: ${marked}</div>
                <div class="heatmap-tooltip-stat" style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 4px; padding-top: 4px;">Time: ${timeStr}</div>
            `;

            heatmapTooltip.style.display = 'block';
            heatmapTooltip.style.left = event.pageX + 10 + 'px';
            heatmapTooltip.style.top = event.pageY + 10 + 'px';
        }

        function hideHeatmapTooltip() {
            if (heatmapTooltip) {
                heatmapTooltip.style.display = 'none';
            }
        }

        // Backup & Reset
        function openBackupModal() {
            document.getElementById('backup-modal').classList.add('show');
        }

        function closeBackupModal() {
            document.getElementById('backup-modal').classList.remove('show');
        }

        function downloadBackup() {
            const questionData = localStorage.getItem('questionData') || '{}';
            const notes = localStorage.getItem('questionNotes') || '{}';

            // Combine data and notes into one backup object
            const backup = {
                questionData: JSON.parse(questionData),
                notes: JSON.parse(notes),
                backupDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `usmle-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function restoreBackup() {
            const file = document.getElementById('restore-file').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    // Check if it's new format with notes (has backupDate field)
                    let questionData;
                    let notes = {};
                    let migrationInfo = null;

                    if (data.backupDate && data.questionData) {
                        // New format with notes
                        questionData = data.questionData;
                        notes = data.notes || {};
                    } else if (data.questionData && !data.backupDate) {
                        // Old format - needs migration
                        const result = migrateOldBackup(data.questionData);
                        questionData = result.data;
                        migrationInfo = result.stats;
                    } else {
                        // Very old format - use directly
                        questionData = data;
                    }

                    // Load existing data from localStorage
                    const existingQuestionData = JSON.parse(localStorage.getItem('questionData') || '{}');
                    const existingNotes = JSON.parse(localStorage.getItem('questionNotes') || '{}');

                    // Merge question data
                    Object.keys(questionData).forEach(qid => {
                        if (!existingQuestionData[qid]) {
                            // Question doesn't exist locally, add from backup
                            existingQuestionData[qid] = questionData[qid];
                        } else {
                            // Question exists, merge intelligently
                            const existing = existingQuestionData[qid];
                            const incoming = questionData[qid];

                            existingQuestionData[qid] = {
                                isFlagged: existing.isFlagged || incoming.isFlagged,
                                isCorrect: existing.isCorrect || incoming.isCorrect,
                                isIncorrect: existing.isIncorrect || incoming.isIncorrect,
                                attempts: Math.max(existing.attempts || 0, incoming.attempts || 0),
                                lastAttempted: new Date(existing.lastAttempted || 0) > new Date(incoming.lastAttempted || 0)
                                    ? existing.lastAttempted
                                    : incoming.lastAttempted
                            };
                        }
                    });

                    // Merge notes (incoming notes overwrite existing ones for same question)
                    Object.keys(notes).forEach(qid => {
                        if (notes[qid] && notes[qid].trim() !== '') {
                            existingNotes[qid] = notes[qid];
                        }
                    });

                    // Save merged data
                    localStorage.setItem('questionData', JSON.stringify(existingQuestionData));
                    localStorage.setItem('questionNotes', JSON.stringify(existingNotes));

                    // Show success message with migration info
                    if (migrationInfo) {
                        const msg = ` Backup do USMLE Environment migrado com sucesso!\n\n` +
                                  ` Seus dados foram importados:\n` +
                                  ` Total de questes: ${migrationInfo.total}\n` +
                                  ` Corretas: ${migrationInfo.correct}\n` +
                                  ` Incorretas: ${migrationInfo.incorrect}\n` +
                                  ` Marcadas (flags): ${migrationInfo.flagged}\n\n` +
                                  ` Seu progresso foi convertido do app antigo para o novo formato!\n` +
                                  `Agora voc pode usar todas as novas funcionalidades.`;
                        alert(msg);
                    } else {
                        alert(' Backup restaurado com sucesso!');
                    }

                    closeBackupModal();

                    // Invalidate stats cache after restore
                    statsCache = null;

                    updateStats();
                    renderSystems();
                    if (currentSystem && currentTopic) {
                        loadTopic(currentSystem, currentTopic);
                    }
                } catch (err) {
                    console.error('Restore error:', err);
                    alert('Invalid backup file! Error: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // Migrate old backup format to new format
        function migrateOldBackup(oldData) {
            const newData = {};
            const stats = {
                total: 0,  // Will be correct + incorrect (only answered questions)
                correct: 0,
                incorrect: 0,
                flagged: 0
            };

            for (const [qId, oldQuestion] of Object.entries(oldData)) {
                // Convert old format to new format
                // Handle all possible field variations from old app
                const isFlagged = oldQuestion.mark === true; // Explicitly check for true
                const isCorrect = oldQuestion.correct === true;
                const isIncorrect = oldQuestion.incorrect === true;
                const selectedAnswer = oldQuestion.choice || ''; // Migrate the selected answer letter

                // Only add question if it has any data (not just an empty object)
                if (oldQuestion.date || isCorrect || isIncorrect || isFlagged || selectedAnswer) {
                    newData[qId] = {
                        isFlagged: isFlagged,
                        isCorrect: isCorrect,
                        isIncorrect: isIncorrect,
                        attempts: (isCorrect || isIncorrect) ? 1 : 0,
                        lastAttempted: oldQuestion.date || new Date().toISOString().split('T')[0],
                        selectedAnswer: selectedAnswer
                    };

                    // Count statistics
                    if (isCorrect) stats.correct++;
                    if (isIncorrect) stats.incorrect++;
                    if (isFlagged) stats.flagged++;
                }
            }

            // Total = only answered questions (correct + incorrect)
            stats.total = stats.correct + stats.incorrect;

            return {
                data: newData,
                stats: stats
            };
        }

        function openResetModal() {
            document.getElementById('reset-modal').classList.add('show');
        }

        function closeResetModal() {
            document.getElementById('reset-modal').classList.remove('show');
        }

        function confirmReset() {
            if (confirm('Are you sure? This will delete ALL progress!')) {
                localStorage.removeItem('questionData');
                localStorage.removeItem('questionNotes'); // Also clear notes
                closeResetModal();
                alert('All progress has been reset.');

                // Invalidate stats cache after reset
                statsCache = null;

                updateStats();
                renderSystems();
                document.getElementById('content-body').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h2>Ready to Study?</h2>
                        <p>Select a system and topic from the sidebar to start practicing questions</p>
                    </div>
                `;
            }
        }

        // New reset function from backup modal
        function confirmResetFromBackup() {
            if (confirm('Are you sure? This will delete ALL progress, test history, and notes!')) {
                localStorage.removeItem('questionData');
                localStorage.removeItem('questionNotes');
                localStorage.removeItem('testHistory');
                closeBackupModal();
                alert('All data has been reset.');

                // Invalidate stats cache after reset
                statsCache = null;

                updateStats();
                renderSystems();
                document.getElementById('content-body').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h2>Ready to Study?</h2>
                        <p>Select a system and topic from the sidebar to start practicing questions</p>
                    </div>
                `;
            }
        }

        // Helper function to find which system a question belongs to
        function getSystemForQuestionId(qId) {
            for (const system in topics) {
                for (const topic in topics[system]) {
                    if (topics[system][topic].includes(qId)) {
                        return system;
                    }
                }
            }
            return null; // Question not found in any system
        }

        // Test History Functions
        function saveTestToHistory(questionIds) {
            const history = JSON.parse(localStorage.getItem('testHistory') || '[]');

            // Group questions by system
            const systemBreakdown = {};
            questionIds.forEach(qId => {
                const system = getSystemForQuestionId(qId);
                if (system) {
                    if (!systemBreakdown[system]) {
                        systemBreakdown[system] = [];
                    }
                    systemBreakdown[system].push(qId);
                }
            });

            const testEntry = {
                id: 'test_' + Date.now(),
                questionIds: questionIds,
                date: new Date().toISOString(),
                questionCount: questionIds.length,
                totalTime: 0, // Will be updated when test finishes
                timePerQuestion: 0, // Will be updated when test finishes
                systemBreakdown: systemBreakdown, // Store which questions belong to which system
                timeBySystem: {}, // Will be updated when test finishes
                startTime: Date.now() // Track when test started
            };

            history.push(testEntry);
            localStorage.setItem('testHistory', JSON.stringify(history));
        }

        function updateTestTimeInHistory() {
            const history = JSON.parse(localStorage.getItem('testHistory') || '[]');

            if (history.length === 0) return;

            // Update the most recent test (last in array)
            const lastTest = history[history.length - 1];

            // Get current stopwatch time (in milliseconds)
            const totalTime = elapsedMs;
            const timePerQuestion = lastTest.questionCount > 0 ? Math.round(totalTime / lastTest.questionCount) : 0;

            lastTest.totalTime = totalTime;
            lastTest.timePerQuestion = timePerQuestion;

            // Calculate time per system based on proportion of questions
            const timeBySystem = {};
            if (lastTest.systemBreakdown) {
                for (const system in lastTest.systemBreakdown) {
                    const questionsInSystem = lastTest.systemBreakdown[system].length;
                    const proportion = questionsInSystem / lastTest.questionCount;
                    timeBySystem[system] = Math.round(totalTime * proportion);
                }
            }
            lastTest.timeBySystem = timeBySystem;

            localStorage.setItem('testHistory', JSON.stringify(history));
        }

        function openTestHistoryModal() {
            document.getElementById('test-history-modal').classList.add('show');
            renderTestHistory();
        }

        function closeTestHistoryModal() {
            document.getElementById('test-history-modal').classList.remove('show');
        }

        function renderTestHistory() {
            const container = document.getElementById('test-history-content');
            const showImported = document.getElementById('show-imported-tests').checked;

            // Get test history
            const history = JSON.parse(localStorage.getItem('testHistory') || '[]');

            // Get questions with attempts from questionData (for imported tests)
            const questionData = JSON.parse(localStorage.getItem('questionData') || '{}');

            let testsToShow = [...history];

            // If checkbox is checked, add imported tests grouped by date
            if (showImported) {
                const importedTests = groupQuestionsByDate(questionData);
                testsToShow = [...testsToShow, ...importedTests];
            }

            // Sort by date (newest first)
            testsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (testsToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <div style="font-size: 48px; margin-bottom: 12px;"></div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No Test History</div>
                        <div>Start a test to see it appear here.</div>
                    </div>
                `;
                return;
            }

            let html = '';

            testsToShow.forEach((test, index) => {
                const date = new Date(test.date);
                const dateStr = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const timeStr = date.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const isImported = test.id.startsWith('imported_');
                const label = isImported ? ' Imported' : ' Test';

                // Categorize questions by status
                let correctIds = [];
                let incorrectIds = [];
                let markedIds = [];
                let allIds = test.questionIds;

                test.questionIds.forEach(qId => {
                    const data = questionData[qId];
                    if (data) {
                        if (data.isCorrect) correctIds.push(qId);
                        if (data.isIncorrect) incorrectIds.push(qId);
                        if (data.isFlagged) markedIds.push(qId);
                    }
                });

                const accuracy = (correctIds.length + incorrectIds.length) > 0
                    ? Math.round((correctIds.length / (correctIds.length + incorrectIds.length)) * 100)
                    : 0;

                // Format time
                const totalTime = test.totalTime || 0;
                const timePerQuestion = test.timePerQuestion || 0;

                const totalMinutes = Math.floor(totalTime / 60000);
                const totalSeconds = Math.floor((totalTime % 60000) / 1000);
                const totalTimeStr = totalTime > 0 ? `${totalMinutes}m ${totalSeconds}s` : 'N/A';

                const avgSeconds = Math.floor(timePerQuestion / 1000);
                const avgTimeStr = timePerQuestion > 0 ? `${avgSeconds}s` : 'N/A';

                html += `
                    <div class="planner-card">
                        <div class="planner-card-header">
                            <div class="planner-card-title">${label} - ${dateStr} ${timeStr}</div>
                            <div class="planner-card-priority" style="background: ${isImported ? '#9e9e9e' : 'var(--primary)'}">
                                ${test.questionCount} questions
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: white;">${accuracy}%</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">Accuracy</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: white;">${totalTimeStr}</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">Total Time</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: white;">${avgTimeStr}</div>
                                <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 4px;">Avg per Question</div>
                            </div>
                        </div>

                        <div class="planner-card-strategy">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <strong>Question IDs:</strong>
                                <select id="filter-${test.id}" class="form-input" style="width: auto; padding: 4px 8px; font-size: 12px;" onchange="updateTestHistoryIds('${test.id}')">
                                    <option value="all">All (${allIds.length})</option>
                                    <option value="correct">Correct (${correctIds.length})</option>
                                    <option value="incorrect">Incorrect (${incorrectIds.length})</option>
                                    <option value="marked">Marked (${markedIds.length})</option>
                                </select>
                            </div>
                            <textarea readonly id="ids-${test.id}" style="width: 100%; min-height: 60px; padding: 8px; font-family: monospace; font-size: 12px; border: 1px solid var(--border); border-radius: 4px;">${allIds.join(', ')}</textarea>
                        </div>
                        <div class="planner-card-actions">
                            <button class="btn btn-secondary" onclick="copyTestHistoryIds('${test.id}')"> Copy IDs</button>
                            <button class="btn btn-primary" onclick="startTestWithTestHistoryIds('${test.id}')"> Start Test</button>
                        </div>
                    </div>
                `;

                // Store the categorized IDs for this test
                window['testHistoryData_' + test.id] = {
                    all: allIds,
                    correct: correctIds,
                    incorrect: incorrectIds,
                    marked: markedIds
                };
            });

            container.innerHTML = html;
        }

        function updateTestHistoryIds(testId) {
            const filterSelect = document.getElementById('filter-' + testId);
            const idsTextarea = document.getElementById('ids-' + testId);
            const filterValue = filterSelect.value;

            const data = window['testHistoryData_' + testId];
            if (!data) return;

            const selectedIds = data[filterValue] || [];
            idsTextarea.value = selectedIds.join(', ');
        }

        function copyTestHistoryIds(testId) {
            const idsTextarea = document.getElementById('ids-' + testId);
            const text = idsTextarea.value;

            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    // Visual feedback
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = ' Copied!';
                    btn.style.background = '#4caf50';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                });
            }
        }

        function startTestWithTestHistoryIds(testId) {
            const idsTextarea = document.getElementById('ids-' + testId);
            const idsString = idsTextarea.value;

            if (!idsString || idsString.trim() === '') {
                alert('No questions selected. Please select a filter option.');
                return;
            }

            startTestWithIds(idsString);
        }

        function groupQuestionsByDate(questionData) {
            const dateGroups = {};

            // Group questions by lastAttempted date
            for (const qId in questionData) {
                const data = questionData[qId];
                if (data.lastAttempted) {
                    const date = data.lastAttempted; // Already in YYYY-MM-DD format

                    if (!dateGroups[date]) {
                        dateGroups[date] = [];
                    }

                    // Only add if question was actually attempted (not just flagged)
                    if (data.isCorrect || data.isIncorrect) {
                        dateGroups[date].push(qId);
                    }
                }
            }

            // Convert to test format
            const importedTests = [];
            for (const date in dateGroups) {
                if (dateGroups[date].length > 0) {
                    importedTests.push({
                        id: 'imported_' + date,
                        questionIds: dateGroups[date],
                        date: date + 'T12:00:00.000Z', // Add time for proper sorting
                        questionCount: dateGroups[date].length
                    });
                }
            }

            return importedTests;
        }

        // Anki Converter Functions
        function openAnkiConverterModal() {
            const modal = document.getElementById('anki-converter-modal');
            modal.classList.add('show');

            // Load saved preferences
            const savedDeck = localStorage.getItem('ankiDeck') || 'general';
            const savedVersion = localStorage.getItem('ankiVersion') || 'v12';

            document.getElementById('anki-deck').value = savedDeck;
            document.getElementById('anki-version').value = savedVersion;

            // Check for sidebar questions
            updateSidebarInfo();

            // Reset state
            document.getElementById('anki-result').style.display = 'none';
            document.getElementById('custom-input-section').style.display = 'none';
        }

        function closeAnkiConverterModal() {
            document.getElementById('anki-converter-modal').classList.remove('show');
        }

        function updateSidebarInfo() {
            const info = document.getElementById('sidebar-info');

            if (isTestMode && testQuestions && testQuestions.length > 0) {
                info.textContent = ` ${testQuestions.length} questions available in sidebar`;
                info.style.color = '#4caf50';
                document.getElementById('use-sidebar-btn').disabled = false;
            } else {
                info.textContent = ' No test active. Use custom input instead.';
                info.style.color = '#f44336';
                document.getElementById('use-sidebar-btn').disabled = true;
            }
        }

        function useSidebarQuestions() {
            if (!isTestMode || !testQuestions || testQuestions.length === 0) {
                alert('No test is currently active. Please start a test first or use custom input.');
                return;
            }

            // Populate textarea with sidebar questions
            document.getElementById('anki-question-ids').value = testQuestions.join(', ');

            // Update buttons
            document.getElementById('use-sidebar-btn').classList.remove('btn-secondary');
            document.getElementById('use-sidebar-btn').classList.add('btn-primary');
            document.getElementById('use-custom-btn').classList.remove('btn-primary');
            document.getElementById('use-custom-btn').classList.add('btn-secondary');

            // Hide custom input
            document.getElementById('custom-input-section').style.display = 'none';
        }

        function useCustomQuestions() {
            // Show custom input
            document.getElementById('custom-input-section').style.display = 'block';

            // Update buttons
            document.getElementById('use-custom-btn').classList.remove('btn-secondary');
            document.getElementById('use-custom-btn').classList.add('btn-primary');
            document.getElementById('use-sidebar-btn').classList.remove('btn-primary');
            document.getElementById('use-sidebar-btn').classList.add('btn-secondary');

            // Focus on textarea
            document.getElementById('anki-question-ids').focus();
        }

        function generateAnkiQuery() {
            const idsInput = document.getElementById('anki-question-ids').value.trim();

            if (!idsInput) {
                alert('Please select a question source or enter question IDs');
                return;
            }

            // Parse IDs
            const questionIds = idsInput
                .split(/[,\s]+/)
                .map(id => id.trim())
                .filter(id => id !== '' && !isNaN(id));

            if (questionIds.length === 0) {
                alert('No valid question IDs found');
                return;
            }

            // Get selections
            const deck = document.getElementById('anki-deck').value;
            const version = document.getElementById('anki-version').value;

            // Save preferences
            localStorage.setItem('ankiDeck', deck);
            localStorage.setItem('ankiVersion', version);

            // Generate query based on version and deck
            let queryParts = [];

            for (const id of questionIds) {
                let queryPart;

                if (version === 'v11') {
                    // V11 logic (no ::Step::)
                    if (deck === 'general') {
                        queryPart = `tag:*UWorld*::${id}`;
                    } else {
                        const deckPrefix = getDeckPrefix(deck, version);
                        queryPart = `tag:${deckPrefix}#UWorld::${id}`;
                    }
                } else {
                    // V12 logic (has ::Step::)
                    if (deck === 'general') {
                        queryPart = `tag:*UWorld::Step::${id}`;
                    } else {
                        const deckPrefix = getDeckPrefix(deck, version);
                        queryPart = `tag:${deckPrefix}#UWorld::Step::${id}`;
                    }
                }

                queryParts.push(queryPart);
            }

            const finalQuery = queryParts.join(' OR ');

            // Display result
            document.getElementById('anki-query-output').value = finalQuery;
            document.getElementById('anki-result').style.display = 'block';
        }

        function getDeckPrefix(deck, version) {
            const prefixes = {
                step1: `#AK_Step1_${version}::`,
                step2ck: `#AK_Step2_${version}::`,
                step3: `#AK_Step3_${version}::`
            };

            return prefixes[deck] || '';
        }

        function copyAnkiQuery() {
            const query = document.getElementById('anki-query-output').value;

            const textarea = document.createElement('textarea');
            textarea.value = query;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                alert(' Anki query copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy:', err);
                alert(' Failed to copy. Please copy manually.');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // Study Planner Functions
        function openStudyPlannerModal() {
            document.getElementById('study-planner-modal').classList.add('show');
            // Update available count for random mode
            updateRandomAvailableCount();
        }

        function closeStudyPlannerModal() {
            document.getElementById('study-planner-modal').classList.remove('show');
        }

        function switchPlannerMode(mode) {
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'active');
                btn.classList.add('btn-secondary');
            });
            document.getElementById(`mode-${mode}-btn`).classList.remove('btn-secondary');
            document.getElementById(`mode-${mode}-btn`).classList.add('btn-primary', 'active');

            // Show/hide content
            document.querySelectorAll('.planner-mode-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`planner-${mode}-content`).style.display = 'block';

            // Update data if needed
            if (mode === 'random') {
                updateRandomAvailableCount();
            }
        }

        function updateRandomAvailableCount() {
            const remaining = getRemainingQuestions();
            document.getElementById('random-available-count').textContent =
                ` Available: ${remaining.length} remaining questions`;
        }

        function getRemainingQuestions() {
            const allQuestions = [];
            for (const system in topics) {
                for (const topic in topics[system]) {
                    topics[system][topic].forEach(qId => {
                        const data = getData(qId);
                        if (!data.isCorrect && !data.isIncorrect) {
                            allQuestions.push(qId);
                        }
                    });
                }
            }
            return allQuestions;
        }

        function generateRandomReview() {
            const count = parseInt(document.getElementById('random-count').value);
            const remaining = getRemainingQuestions();

            if (!count || count <= 0) {
                alert('Please enter a valid number of questions');
                return;
            }

            if (remaining.length === 0) {
                alert('No remaining questions available!');
                return;
            }

            if (count > remaining.length) {
                alert(`Only ${remaining.length} remaining questions available. Adjusting to maximum.`);
            }

            // Shuffle and take requested count
            const shuffled = remaining.sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, Math.min(count, remaining.length));
            const idsString = selected.join(', ');

            // Display results
            const resultsDiv = document.getElementById('random-results');
            resultsDiv.innerHTML = `
                <div class="planner-card">
                    <div class="planner-card-header">
                        <div class="planner-card-title"> Random Review Generated</div>
                    </div>
                    <div class="planner-card-stats">
                        <div class="planner-stat">
                            <div class="planner-stat-label">Questions</div>
                            <div class="planner-stat-value">${selected.length}</div>
                        </div>
                        <div class="planner-stat">
                            <div class="planner-stat-label">Type</div>
                            <div class="planner-stat-value">Unattempted</div>
                        </div>
                    </div>
                    <div class="planner-card-strategy">
                        <strong>Question IDs:</strong><br>
                        <textarea readonly style="width: 100%; min-height: 80px; margin-top: 8px; padding: 8px; font-family: monospace; font-size: 12px; border: 1px solid var(--border); border-radius: 4px;">${idsString}</textarea>
                    </div>
                    <div class="planner-card-actions">
                        <button class="btn btn-primary" onclick="copyToClipboard('${idsString.replace(/'/g, "\\'")}')"> Copy IDs</button>
                        <button class="btn btn-primary" onclick="startTestWithIds('${idsString.replace(/'/g, "\\'")}')"> Start Test</button>
                    </div>
                </div>
            `;
        }

        // Removed - using unified copyToClipboard function below

        function startTestWithIds(idsString) {
            const questionIds = idsString.split(',').map(id => id.trim());

            // Start test
            testQuestions = questionIds;
            currentTestIndex = 0;
            isTestMode = true;

            // Update UI - activate test mode in header
            document.getElementById('start-test-btn').style.display = 'none';
            document.getElementById('finish-test-btn').style.display = 'inline-block';
            document.getElementById('test-nav-arrows').classList.add('active');
            document.getElementById('question-search').disabled = true;

            const container = document.getElementById('container');
            container.classList.add('test-mode');
            document.body.classList.add('test-mode-active');

            // Auto-start stopwatch and enable auto-pause
            stopStopwatch(); // Reset stopwatch first
            const autoPauseCheckbox = document.getElementById('autoPauseOnSubmit');
            autoPauseCheckbox.checked = true;
            localStorage.setItem('autoPauseOnSubmit', 'true');
            startStopwatch(); // Start automatically

            renderTestSidebar();
            openTestQuestion(currentTestIndex);
            saveTestState();

            // Save to test history
            saveTestToHistory(testQuestions);

            closeStudyPlannerModal();
        }

        function getAllStats() {
            let totalQuestions = 0, correct = 0, incorrect = 0;

            for (const system in topics) {
                for (const topic in topics[system]) {
                    topics[system][topic].forEach(qId => {
                        totalQuestions++;
                        const data = getData(qId);
                        if (data.isCorrect) correct++;
                        if (data.isIncorrect) incorrect++;
                    });
                }
            }

            const attempted = correct + incorrect;
            const accuracy = attempted > 0 ? ((correct / attempted) * 100).toFixed(1) : 0;

            return { totalQuestions, correct, incorrect, attempted, accuracy: parseFloat(accuracy) };
        }

        function generateAccuracyBoost() {
            const targetAccuracy = parseFloat(document.getElementById('target-accuracy').value);
            const prioritizeUnattempted = document.getElementById('prioritize-unattempted').checked;

            if (!targetAccuracy || targetAccuracy < 0 || targetAccuracy > 100) {
                alert('Please enter a valid target accuracy between 0 and 100');
                return;
            }

            // Get current overall stats
            const overallStats = getAllStats();
            const currentAccuracy = overallStats.accuracy;

            if (currentAccuracy >= targetAccuracy) {
                alert(`Your current accuracy (${currentAccuracy}%) already meets or exceeds your target (${targetAccuracy}%)! `);
                return;
            }

            // Calculate priority scores for each subtopic
            const priorities = [];
            const today = new Date();

            for (const system in topics) {
                for (const topic in topics[system]) {
                    const fullTopicName = `${system}  ${topic}`;
                    const questionIds = topics[system][topic];
                    const stats = calculateSubtopicStats(questionIds, today, prioritizeUnattempted);

                    if (stats.total > 0) {
                        // Skip subtopics with majority unattempted if checkbox is unchecked
                        const attemptedCount = stats.correct + stats.incorrect;
                        if (!prioritizeUnattempted && attemptedCount < stats.total * 0.3) {
                            // Less than 30% attempted - skip this subtopic
                            continue;
                        }

                        const score = calculatePriorityScore(stats, overallStats.totalQuestions);
                        priorities.push({
                            name: fullTopicName,
                            system: system,
                            topic: topic,
                            score: score,
                            stats: stats,
                            questionIds: questionIds
                        });
                    }
                }
            }

            // Sort by score (highest priority first)
            priorities.sort((a, b) => b.score - a.score);

            // Calculate cumulative accuracy gains
            let cumulativeCorrect = overallStats.correct;
            let cumulativeIncorrect = overallStats.incorrect;
            let cumulativeAccuracy = currentAccuracy;

            const recommendations = priorities.slice(0, 10).map((priority, index) => {
                // Calculate expected gain if user achieves target accuracy on these questions
                const questionsToReview = priority.stats.incorrect + priority.stats.unattempted;
                const expectedCorrect = Math.round(questionsToReview * (targetAccuracy / 100));
                const expectedIncorrect = questionsToReview - expectedCorrect;

                // Update cumulative stats
                cumulativeCorrect += expectedCorrect;
                cumulativeIncorrect += expectedIncorrect;
                const newAccuracy = ((cumulativeCorrect / (cumulativeCorrect + cumulativeIncorrect)) * 100).toFixed(1);
                const gain = (newAccuracy - cumulativeAccuracy).toFixed(1);

                cumulativeAccuracy = newAccuracy;

                return {
                    ...priority,
                    index: index + 1,
                    questionsToReview: questionsToReview,
                    expectedAccuracy: newAccuracy,
                    gain: gain
                };
            });

            // Display results
            displayAccuracyBoostResults(recommendations, targetAccuracy, currentAccuracy);
        }

        function calculateSubtopicStats(questionIds, today, prioritizeUnattempted = false) {
            let correct = 0, incorrect = 0, unattempted = 0;
            let totalDays = 0;
            let attemptedCount = 0;

            questionIds.forEach(qId => {
                const data = getData(qId);
                if (data.isCorrect) {
                    correct++;
                    attemptedCount++;
                } else if (data.isIncorrect) {
                    incorrect++;
                    attemptedCount++;
                } else {
                    unattempted++;
                }

                // Calculate days since last attempt
                if (data.lastAttempted) {
                    const lastDate = new Date(data.lastAttempted);
                    const daysDiff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                    totalDays += daysDiff;
                }
            });

            // Set defaults for unattempted questions based on checkbox
            let avgDaysSinceAttempt, errorRate;

            if (attemptedCount > 0) {
                avgDaysSinceAttempt = totalDays / attemptedCount;
                errorRate = incorrect / attemptedCount;
            } else {
                // All questions are unattempted
                if (prioritizeUnattempted) {
                    avgDaysSinceAttempt = 90;  // Max priority
                    errorRate = 1.0;           // Max priority
                } else {
                    avgDaysSinceAttempt = 0;   // Min priority
                    errorRate = 0;             // Min priority
                }
            }

            const accuracy = attemptedCount > 0 ? (correct / attemptedCount) * 100 : 0;

            return {
                total: questionIds.length,
                correct,
                incorrect,
                unattempted,
                errorRate,
                accuracy,
                avgDaysSinceAttempt
            };
        }

        function calculatePriorityScore(stats, totalQuestions) {
            // Normalize components to 0-1 scale
            const errorRateNorm = stats.errorRate; // Already 0-1
            const weightNorm = stats.total / totalQuestions; // Already 0-1
            const daysNorm = 1 - Math.exp(-stats.avgDaysSinceAttempt / 30); // Exponential decay

            // Weighted score
            return (errorRateNorm * 0.5) + (weightNorm * 0.3) + (daysNorm * 0.2);
        }

        function displayAccuracyBoostResults(recommendations, targetAccuracy, currentAccuracy) {
            const resultsDiv = document.getElementById('accuracy-results');

            if (recommendations.length === 0) {
                resultsDiv.innerHTML = '<p>No recommendations available.</p>';
                return;
            }

            let html = '';

            recommendations.forEach(rec => {
                const impactLevel = rec.gain > 3 ? 'High' : rec.gain > 1 ? 'Medium' : 'Low';
                const impactColor = impactLevel === 'High' ? '#4caf50' : impactLevel === 'Medium' ? '#ff9800' : '#9e9e9e';

                // Get IDs to review (incorrect + unattempted)
                const reviewIds = [];
                rec.questionIds.forEach(qId => {
                    const data = getData(qId);
                    if (data.isIncorrect || (!data.isCorrect && !data.isIncorrect)) {
                        reviewIds.push(qId);
                    }
                });
                const idsString = reviewIds.join(', ');

                html += `
                    <div class="planner-card">
                        <div class="planner-card-header">
                            <div class="planner-card-title">${rec.name}</div>
                            <div class="planner-card-priority">Priority ${rec.index}</div>
                        </div>
                        <div class="planner-card-stats">
                            <div class="planner-stat">
                                <div class="planner-stat-label">Current Accuracy</div>
                                <div class="planner-stat-value">${rec.stats.accuracy.toFixed(1)}%</div>
                            </div>
                            <div class="planner-stat">
                                <div class="planner-stat-label">Impact</div>
                                <div class="planner-stat-value" style="color: ${impactColor}">${impactLevel}</div>
                            </div>
                            <div class="planner-stat">
                                <div class="planner-stat-label">Questions to Review</div>
                                <div class="planner-stat-value">${rec.questionsToReview}</div>
                            </div>
                        </div>
                        <div class="planner-card-strategy">
                            <strong> Expected Outcome:</strong><br>
                            Review ${rec.stats.incorrect} incorrect + ${rec.stats.unattempted} unattempted questions<br>
                            <strong>Cumulative Accuracy:</strong> ${(currentAccuracy * 1 + rec.gain * 1).toFixed(1)}%  ${rec.expectedAccuracy}% (+${rec.gain}%)
                        </div>
                        <div class="planner-card-actions">
                            <button class="btn btn-secondary" onclick="copyToClipboard('${idsString.replace(/'/g, "\\'")}')"> Copy IDs</button>
                            <button class="btn btn-primary" onclick="startTestWithIds('${idsString.replace(/'/g, "\\'")}')"> Start Review</button>
                        </div>
                    </div>
                `;
            });

            // Add summary
            const lastRec = recommendations[recommendations.length - 1];
            html += `
                <div class="planner-summary">
                     Complete these ${recommendations.length} priority areas to boost your accuracy from ${currentAccuracy}% to ${lastRec.expectedAccuracy}%!
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        function generateWeakAreas() {
            const threshold = parseFloat(document.getElementById('weak-threshold').value);

            if (!threshold || threshold < 0 || threshold > 100) {
                alert('Please enter a valid threshold between 0 and 100');
                return;
            }

            // Find all subtopics below threshold
            const weakAreas = [];
            const today = new Date();

            for (const system in topics) {
                for (const topic in topics[system]) {
                    const fullTopicName = `${system}  ${topic}`;
                    const questionIds = topics[system][topic];
                    const stats = calculateSubtopicStats(questionIds, today);

                    // Only include subtopics that have been attempted and are below threshold
                    if (stats.correct + stats.incorrect > 0 && stats.accuracy < threshold) {
                        weakAreas.push({
                            name: fullTopicName,
                            system: system,
                            topic: topic,
                            stats: stats,
                            questionIds: questionIds
                        });
                    }
                }
            }

            // Sort by number of incorrect answers (most errors first)
            weakAreas.sort((a, b) => b.stats.incorrect - a.stats.incorrect);

            // Display results
            displayWeakAreasResults(weakAreas, threshold);
        }

        function displayWeakAreasResults(weakAreas, threshold) {
            const resultsDiv = document.getElementById('weak-results');

            if (weakAreas.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="planner-card">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 12px;"></div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Great job!</div>
                            <div style="color: var(--text-light);">You don't have any subtopics below ${threshold}% accuracy.</div>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';

            weakAreas.forEach((area, index) => {
                // Get IDs to review (incorrect + unattempted)
                const reviewIds = [];
                area.questionIds.forEach(qId => {
                    const data = getData(qId);
                    if (data.isIncorrect || (!data.isCorrect && !data.isIncorrect)) {
                        reviewIds.push(qId);
                    }
                });
                const idsString = reviewIds.join(', ');

                const accuracyColor = area.stats.accuracy < 40 ? '#f44336' : area.stats.accuracy < 60 ? '#ff9800' : '#ffc107';

                html += `
                    <div class="planner-card">
                        <div class="planner-card-header">
                            <div class="planner-card-title">${area.name}</div>
                            <div class="planner-card-priority" style="background: ${accuracyColor}">
                                ${area.stats.accuracy.toFixed(1)}%
                            </div>
                        </div>
                        <div class="planner-card-stats">
                            <div class="planner-stat">
                                <div class="planner-stat-label">Correct</div>
                                <div class="planner-stat-value" style="color: #4caf50">${area.stats.correct}</div>
                            </div>
                            <div class="planner-stat">
                                <div class="planner-stat-label">Incorrect</div>
                                <div class="planner-stat-value" style="color: #f44336">${area.stats.incorrect}</div>
                            </div>
                            <div class="planner-stat">
                                <div class="planner-stat-label">Unattempted</div>
                                <div class="planner-stat-value">${area.stats.unattempted}</div>
                            </div>
                            <div class="planner-stat">
                                <div class="planner-stat-label">To Review</div>
                                <div class="planner-stat-value">${reviewIds.length}</div>
                            </div>
                        </div>
                        <div class="planner-card-strategy">
                            <strong> Focus Area:</strong><br>
                            This subtopic needs attention. Review ${area.stats.incorrect} incorrect and ${area.stats.unattempted} unattempted questions to improve your understanding.
                        </div>
                        <div class="planner-card-actions">
                            <button class="btn btn-secondary" onclick="copyToClipboard('${idsString.replace(/'/g, "\\'")}')"> Copy IDs</button>
                            <button class="btn btn-primary" onclick="startTestWithIds('${idsString.replace(/'/g, "\\'")}')"> Start Review</button>
                        </div>
                    </div>
                `;
            });

            // Add summary
            html += `
                <div class="planner-summary">
                     Found ${weakAreas.length} weak area${weakAreas.length > 1 ? 's' : ''} below ${threshold}% accuracy. Focus on these to strengthen your knowledge!
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        // Notes Management
        let currentNoteQuestionId = null;

        function openNotesModal() {
            if (!currentNoteQuestionId) return;

            const modal = document.getElementById('notes-modal');
            const textarea = document.getElementById('notes-textarea');
            const questionIdSpan = document.getElementById('notes-question-id');

            questionIdSpan.textContent = currentNoteQuestionId;

            // Load existing note if it exists
            const notes = JSON.parse(localStorage.getItem('questionNotes') || '{}');
            textarea.value = notes[currentNoteQuestionId] || '';

            modal.classList.add('show');
            setTimeout(() => textarea.focus(), 100);
        }

        function closeNotesModal() {
            document.getElementById('notes-modal').classList.remove('show');
        }

        // Close notes modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const notesModal = document.getElementById('notes-modal');
                if (notesModal && notesModal.classList.contains('show')) {
                    closeNotesModal();
                }
            }
        });

        function saveNote() {
            if (!currentNoteQuestionId) return;

            const textarea = document.getElementById('notes-textarea');
            const noteText = textarea.value.trim();

            // Get existing notes
            const notes = JSON.parse(localStorage.getItem('questionNotes') || '{}');

            if (noteText) {
                // Save note
                notes[currentNoteQuestionId] = noteText;
            } else {
                // Delete note if empty
                delete notes[currentNoteQuestionId];
            }

            // Save to localStorage
            localStorage.setItem('questionNotes', JSON.stringify(notes));

            // Check storage usage after saving
            checkStorageUsage();

            closeNotesModal();
        }

        function getStorageSize() {
            // Calculate total size of localStorage in bytes
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length + key.length;
                }
            }
            return total;
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function checkStorageUsage() {
            const totalSize = getStorageSize();
            const limitSize = 5 * 1024 * 1024; // 5MB limit (conservative estimate)
            const usagePercent = (totalSize / limitSize) * 100;

            if (usagePercent >= 90) {
                // Get notes sizes
                const notes = JSON.parse(localStorage.getItem('questionNotes') || '{}');
                const noteSizes = [];

                for (let qId in notes) {
                    const noteSize = new Blob([notes[qId]]).size;
                    const percent = (noteSize / limitSize) * 100;
                    noteSizes.push({
                        questionId: qId,
                        size: noteSize,
                        percent: percent
                    });
                }

                // Sort by size (largest first)
                noteSizes.sort((a, b) => b.size - a.size);

                // Build warning message
                let message = ` AVISO: Uso de Armazenamento Alto!\n\n`;
                message += `Uso atual: ${formatBytes(totalSize)} / ${formatBytes(limitSize)} (${usagePercent.toFixed(1)}%)\n\n`;

                if (noteSizes.length > 0) {
                    message += ` Maiores notas (top 5):\n\n`;
                    const topNotes = noteSizes.slice(0, 5);
                    topNotes.forEach((note, index) => {
                        message += `${index + 1}. Question ${note.questionId}\n`;
                        message += `   Tamanho: ${formatBytes(note.size)} (${note.percent.toFixed(2)}%)\n\n`;
                    });
                    message += `\n Sugesto: Considere reduzir ou remover notas muito grandes para liberar espao.`;
                }

                alert(message);
            }
        }

        // Render Topic Sidebar (for normal question viewing)
        function renderTopicSidebar() {
            if (!currentSystem || !currentTopic) return;

            const questionIds = topics[currentSystem][currentTopic];
            const sidebar = document.querySelector('.sidebar');
            sidebar.innerHTML = `
                <div class="test-sidebar-header">
                    <div class="test-sidebar-title">${currentTopic}</div>
                    <div class="test-sidebar-info">${questionIds.length} Questions</div>
                </div>
                <div class="test-questions-list">
                    ${questionIds.map(qId => {
                        const data = getData(qId);
                        const statusIcons = [];
                        if (data.isFlagged) statusIcons.push('');
                        if (data.isCorrect) statusIcons.push('');
                        if (data.isIncorrect) statusIcons.push('');

                        return `
                            <div class="test-question-item ${qId == currentQuestionId ? 'active' : ''}"
                                 onclick="openQuestion(${qId})"
                                 data-question-id="${qId}">
                                <div class="test-question-number">Q ${qId}</div>
                                <div class="test-question-status">${statusIcons.join(' ')}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updateSingleTopicSidebarItem(questionId) {
            // Find the topic sidebar item for this specific question
            const item = document.querySelector(`.test-question-item[data-question-id="${questionId}"]`);
            if (!item) return;

            const data = getData(questionId);
            const statusIcons = [];
            if (data.isFlagged) statusIcons.push('');
            if (data.isCorrect) statusIcons.push('');
            if (data.isIncorrect) statusIcons.push('');

            // Update only the status part
            const statusElement = item.querySelector('.test-question-status');
            if (statusElement) {
                statusElement.textContent = statusIcons.join(' ');
            }
        }

        // Media Maximizer Functions
        function setupIframeMediaHandler() {
            const iframe = document.getElementById('question-iframe');
            if (!iframe) return;

            iframe.onload = function() {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Add click handlers to images, videos, and audio
                const media = iframeDoc.querySelectorAll('img, video, audio');
                media.forEach(item => {
                    item.style.cursor = 'pointer';
                    item.style.transition = 'transform 0.2s';

                    item.addEventListener('mouseenter', () => {
                        item.style.transform = 'scale(1.05)';
                    });

                    item.addEventListener('mouseleave', () => {
                        item.style.transform = 'scale(1)';
                    });

                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        openMediaModal(item);
                    });
                });

                // Apply bionic reading if enabled
                if (bionicReadingEnabled) {
                    applyBionicReading();
                }
            };
        }

        function injectQuestionStyles(iframeDoc) {
            const style = iframeDoc.createElement('style');
            style.textContent = `
                * {
                    box-sizing: border-box !important;
                }

                body {
                    font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
                    line-height: 1.9 !important;
                    color: #1f1f1f !important;
                    max-width: 980px !important;
                    margin: 0 auto !important;
                    padding: 48px 56px !important;
                    background: #ffffff !important;
                    font-size: 16.5px !important;
                }

                p {
                    margin-bottom: 20px !important;
                    font-size: 16.5px !important;
                    line-height: 1.95 !important;
                    color: #1f1f1f !important;
                    font-weight: 400 !important;
                }

                strong, b {
                    color: #1a73e8 !important;
                    font-weight: 700 !important;
                    background: rgba(26, 115, 232, 0.08) !important;
                    padding: 2px 6px !important;
                    border-radius: 4px !important;
                }

                /* Details/Summary (collapsible sections) */
                details {
                    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
                    border-radius: 16px !important;
                    padding: 24px 28px !important;
                    margin: 24px 0 !important;
                    border: 2px solid #e8eaed !important;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                }

                details:hover {
                    border-color: #1a73e8 !important;
                    box-shadow: 0 8px 20px rgba(26,115,232,0.2) !important;
                    transform: translateY(-2px) !important;
                }

                details[open] {
                    background: #ffffff !important;
                    border-color: #1a73e8 !important;
                    box-shadow: 0 8px 24px rgba(26,115,232,0.15) !important;
                }

                summary {
                    cursor: pointer !important;
                    font-weight: 800 !important;
                    color: #ffffff !important;
                    font-size: 20px !important;
                    padding: 16px 24px !important;
                    border-radius: 12px !important;
                    background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%) !important;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                    display: flex !important;
                    align-items: center !important;
                    user-select: none !important;
                    box-shadow: 0 4px 12px rgba(26,115,232,0.3) !important;
                    letter-spacing: 0.5px !important;
                }

                summary:hover {
                    background: linear-gradient(135deg, #1557b0 0%, #0d47a1 100%) !important;
                    transform: translateX(6px) scale(1.02) !important;
                    box-shadow: 0 6px 16px rgba(26,115,232,0.4) !important;
                }

                summary:active {
                    transform: translateX(4px) scale(0.99) !important;
                }

                summary::marker {
                    color: rgba(255, 255, 255, 0.9) !important;
                    font-size: 1.3em !important;
                }

                summary strong {
                    background: rgba(255, 255, 255, 0.2) !important;
                    color: #ffffff !important;
                    padding: 4px 12px !important;
                    border-radius: 8px !important;
                    margin-left: 8px !important;
                    font-size: 19px !important;
                    letter-spacing: 1px !important;
                }

                /* Tables - Premium Design */
                table {
                    width: 100% !important;
                    border-collapse: separate !important;
                    border-spacing: 0 !important;
                    margin: 28px 0 !important;
                    border-radius: 16px !important;
                    overflow: hidden !important;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.1) !important;
                    border: 2px solid #e8eaed !important;
                    background: #ffffff !important;
                }

                table.simple-table {
                    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
                }

                table tr {
                    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
                    position: relative !important;
                }

                table tr:nth-child(odd) {
                    background: rgba(248, 249, 250, 0.5) !important;
                }

                table tr:nth-child(even) {
                    background: rgba(255, 255, 255, 0.8) !important;
                }

                table tr:hover {
                    background: linear-gradient(90deg, #e8f0fe 0%, #f1f8ff 100%) !important;
                    transform: translateX(4px) scale(1.01) !important;
                    box-shadow: -4px 0 0 0 #1a73e8, 0 4px 12px rgba(26,115,232,0.2) !important;
                    z-index: 1 !important;
                }

                table td {
                    padding: 18px 24px !important;
                    border-bottom: 1px solid rgba(232, 234, 237, 0.6) !important;
                    font-size: 16.5px !important;
                    line-height: 1.7 !important;
                    color: #1f1f1f !important;
                    vertical-align: middle !important;
                }

                table tr:last-child td {
                    border-bottom: none !important;
                }

                /* First column (A, B, C, D, E) */
                table td:first-child {
                    font-weight: 800 !important;
                    color: #ffffff !important;
                    width: 52px !important;
                    text-align: center !important;
                    font-size: 18px !important;
                    background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%) !important;
                    border-right: 3px solid #1557b0 !important;
                    position: relative !important;
                    letter-spacing: 0.5px !important;
                }

                table tr:hover td:first-child {
                    background: linear-gradient(135deg, #1557b0 0%, #0d47a1 100%) !important;
                    box-shadow: 0 0 12px rgba(26,115,232,0.4) !important;
                }

                /* Second column (content) */
                table td:nth-child(2) {
                    font-weight: 500 !important;
                    padding-left: 28px !important;
                }

                /* Third column (empty - hide it) */
                table td:last-child:empty {
                    display: none !important;
                }

                /* Lists */
                ul, ol {
                    margin: 16px 0 !important;
                    padding-left: 32px !important;
                }

                li {
                    margin: 10px 0 !important;
                    line-height: 1.8 !important;
                    color: #1f1f1f !important;
                }

                ul.bulleted-list li {
                    position: relative !important;
                    padding-left: 8px !important;
                }

                ul.toggle {
                    list-style: none !important;
                    padding-left: 0 !important;
                }

                /* Links */
                a {
                    color: #1a73e8 !important;
                    text-decoration: none !important;
                    font-weight: 600 !important;
                    border-bottom: 2px solid transparent !important;
                    transition: all 0.2s ease !important;
                }

                a:hover {
                    border-bottom-color: #1a73e8 !important;
                    color: #1557b0 !important;
                }

                /* Media Elements */
                img, video, audio {
                    max-width: 100% !important;
                    height: auto !important;
                    border-radius: 12px !important;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.12) !important;
                    margin: 24px 0 !important;
                    display: block !important;
                    border: 2px solid #e8eaed !important;
                }

                img:hover, video:hover {
                    box-shadow: 0 6px 20px rgba(26,115,232,0.25) !important;
                    border-color: #1a73e8 !important;
                }

                /* Code blocks (if any) */
                code {
                    background: #f1f3f4 !important;
                    padding: 2px 8px !important;
                    border-radius: 4px !important;
                    font-family: 'Courier New', monospace !important;
                    font-size: 14px !important;
                    color: #d93025 !important;
                }

                pre {
                    background: #f8f9fa !important;
                    padding: 16px !important;
                    border-radius: 8px !important;
                    overflow-x: auto !important;
                    border-left: 4px solid #1a73e8 !important;
                }

                /* Headings */
                h1, h2, h3, h4, h5, h6 {
                    color: #1a73e8 !important;
                    font-weight: 700 !important;
                    margin-top: 24px !important;
                    margin-bottom: 16px !important;
                    line-height: 1.4 !important;
                }

                h1 { font-size: 32px !important; }
                h2 { font-size: 26px !important; }
                h3 { font-size: 22px !important; }
                h4 { font-size: 19px !important; }

                /* Blockquotes */
                blockquote {
                    border-left: 4px solid #1a73e8 !important;
                    padding-left: 20px !important;
                    margin: 20px 0 !important;
                    font-style: italic !important;
                    color: #5f6368 !important;
                    background: #f8f9fa !important;
                    padding: 16px 20px !important;
                    border-radius: 8px !important;
                }

                /* Horizontal Rule */
                hr {
                    border: none !important;
                    height: 2px !important;
                    background: linear-gradient(to right, transparent, #1a73e8, transparent) !important;
                    margin: 32px 0 !important;
                }

                /* Selection */
                ::selection {
                    background: #e8f0fe !important;
                    color: #1a73e8 !important;
                }
            `;
            iframeDoc.head.appendChild(style);
        }

        function openMediaModal(mediaElement) {
            const modal = document.getElementById('media-modal');
            const display = document.getElementById('media-display');

            currentZoom = 1;
            const type = mediaElement.tagName.toLowerCase();

            // Create media element
            let mediaHTML = '';
            if (type === 'img') {
                mediaHTML = `<img id="zoomed-media" src="${mediaElement.src}" alt="Question Image">`;
            } else if (type === 'video') {
                mediaHTML = `<video id="zoomed-media" controls><source src="${mediaElement.src}"></video>`;
            } else if (type === 'audio') {
                mediaHTML = `<div style="text-align: center;">
                    <div style="font-size: 60px; margin-bottom: 20px;"></div>
                    <audio id="zoomed-media" controls style="width: 500px;"><source src="${mediaElement.src}"></audio>
                </div>`;
            }

            display.innerHTML = mediaHTML;
            modal.classList.add('show');

            // Setup interactions
            const zoomedMedia = document.getElementById('zoomed-media');
            if (zoomedMedia && type !== 'audio') {
                setupMediaDrag(zoomedMedia);
                setupMouseWheelZoom(zoomedMedia);
            }

            // Hide body overflow
            document.body.style.overflow = 'hidden';
        }

        function closeMediaModal() {
            const modal = document.getElementById('media-modal');
            modal.classList.remove('show');
            currentZoom = 1;
            document.body.style.overflow = 'auto';
        }

        function zoomMedia(factor) {
            currentZoom *= factor;
            const media = document.getElementById('zoomed-media');
            if (media) {
                media.style.transform = `scale(${currentZoom})`;
                if (currentZoom > 1) {
                    media.classList.add('zoomed');
                } else {
                    media.classList.remove('zoomed');
                }
                updateMediaInfo();
            }
        }

        function resetMediaZoom() {
            currentZoom = 1;
            const media = document.getElementById('zoomed-media');
            if (media) {
                media.style.transform = 'scale(1)';
                media.style.position = 'static';
                media.style.left = '0';
                media.style.top = '0';
                media.classList.remove('zoomed');
                updateMediaInfo();
            }
        }

        function updateMediaInfo() {
            const info = document.getElementById('media-info');
            const zoomPercent = Math.round(currentZoom * 100);
            info.textContent = `Zoom: ${zoomPercent}%  Use scroll do mouse ou botes  Arraste para mover`;
        }

        function setupMouseWheelZoom(media) {
            const container = document.getElementById('media-display-container');
            container.addEventListener('wheel', (e) => {
                e.preventDefault();

                if (e.deltaY < 0) {
                    // Scroll up - zoom in
                    zoomMedia(1.1);
                } else {
                    // Scroll down - zoom out
                    zoomMedia(0.9);
                }
            });
        }

        function setupMediaDrag(media) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            media.addEventListener('mousedown', (e) => {
                if (currentZoom <= 1) return;

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;

                // Get current position
                const style = window.getComputedStyle(media);
                const matrix = new WebKitCSSMatrix(style.transform);
                initialLeft = matrix.m41 || 0;
                initialTop = matrix.m42 || 0;

                media.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                e.preventDefault();
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;

                const newX = initialLeft + deltaX;
                const newY = initialTop + deltaY;

                media.style.transform = `scale(${currentZoom}) translate(${newX / currentZoom}px, ${newY / currentZoom}px)`;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    media.style.cursor = currentZoom > 1 ? 'move' : 'grab';
                }
            });

            // Touch support for mobile
            media.addEventListener('touchstart', (e) => {
                if (currentZoom <= 1 || e.touches.length !== 1) return;

                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;

                const style = window.getComputedStyle(media);
                const matrix = new WebKitCSSMatrix(style.transform);
                initialLeft = matrix.m41 || 0;
                initialTop = matrix.m42 || 0;
            });

            media.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length !== 1) return;

                e.preventDefault();
                const deltaX = e.touches[0].clientX - startX;
                const deltaY = e.touches[0].clientY - startY;

                const newX = initialLeft + deltaX;
                const newY = initialTop + deltaY;

                media.style.transform = `scale(${currentZoom}) translate(${newX / currentZoom}px, ${newY / currentZoom}px)`;
            });

            media.addEventListener('touchend', () => {
                isDragging = false;
            });
        }

        // Question IDs Display Functions
        function showOverallQuestionIds() {
            const correctIds = [];
            const incorrectIds = [];
            const flaggedIds = [];
            const unattemptedIds = [];

            for (const system in topics) {
                for (const topic in topics[system]) {
                    topics[system][topic].forEach(qId => {
                        const data = getData(qId);
                        if (data.isCorrect) correctIds.push(qId);
                        if (data.isIncorrect) incorrectIds.push(qId);
                        if (data.isFlagged) flaggedIds.push(qId);
                        if (!data.isCorrect && !data.isIncorrect) unattemptedIds.push(qId);
                    });
                }
            }

            showQuestionIdsModal('Overall Statistics', correctIds, incorrectIds, flaggedIds, unattemptedIds);
        }

        function showSystemQuestionIds(systemName) {
            const correctIds = [];
            const incorrectIds = [];
            const flaggedIds = [];
            const unattemptedIds = [];

            for (const topic in topics[systemName]) {
                topics[systemName][topic].forEach(qId => {
                    const data = getData(qId);
                    if (data.isCorrect) correctIds.push(qId);
                    if (data.isIncorrect) incorrectIds.push(qId);
                    if (data.isFlagged) flaggedIds.push(qId);
                    if (!data.isCorrect && !data.isIncorrect) unattemptedIds.push(qId);
                });
            }

            showQuestionIdsModal(systemName, correctIds, incorrectIds, flaggedIds, unattemptedIds);
        }

        function showTopicQuestionIds(systemName, topicName) {
            const correctIds = [];
            const incorrectIds = [];
            const flaggedIds = [];
            const unattemptedIds = [];

            topics[systemName][topicName].forEach(qId => {
                const data = getData(qId);
                if (data.isCorrect) correctIds.push(qId);
                if (data.isIncorrect) incorrectIds.push(qId);
                if (data.isFlagged) flaggedIds.push(qId);
                if (!data.isCorrect && !data.isIncorrect) unattemptedIds.push(qId);
            });

            showQuestionIdsModal(`${systemName}  ${topicName}`, correctIds, incorrectIds, flaggedIds, unattemptedIds);
        }

        function showQuestionIdsModal(title, correctIds, incorrectIds, flaggedIds, unattemptedIds = []) {
            const modal = document.getElementById('question-ids-modal');
            const titleEl = document.getElementById('ids-modal-title');
            const body = document.getElementById('ids-modal-body');

            titleEl.textContent = ` ${title}`;

            let html = '';

            // Correct Section
            if (correctIds.length > 0) {
                const idsStr = correctIds.sort((a, b) => a - b).join(', ');
                html += `
                    <div class="ids-section">
                        <div class="ids-section-header correct">
                            <span> Correct (${correctIds.length})</span>
                            <button class="ids-copy-btn" onclick="copyToClipboard('${idsStr}')"> Copy</button>
                        </div>
                        <div class="ids-list">${idsStr}</div>
                    </div>
                `;
            }

            // Incorrect Section
            if (incorrectIds.length > 0) {
                const idsStr = incorrectIds.sort((a, b) => a - b).join(', ');
                html += `
                    <div class="ids-section">
                        <div class="ids-section-header incorrect">
                            <span> Incorrect (${incorrectIds.length})</span>
                            <button class="ids-copy-btn" onclick="copyToClipboard('${idsStr}')"> Copy</button>
                        </div>
                        <div class="ids-list">${idsStr}</div>
                    </div>
                `;
            }

            // Unattempted Section
            if (unattemptedIds.length > 0) {
                const idsStr = unattemptedIds.sort((a, b) => a - b).join(', ');
                html += `
                    <div class="ids-section">
                        <div class="ids-section-header unattempted">
                            <span> Unattempted (${unattemptedIds.length})</span>
                            <button class="ids-copy-btn" onclick="copyToClipboard('${idsStr}')"> Copy</button>
                        </div>
                        <div class="ids-list">${idsStr}</div>
                    </div>
                `;
            }

            // Flagged Section
            if (flaggedIds.length > 0) {
                const idsStr = flaggedIds.sort((a, b) => a - b).join(', ');
                html += `
                    <div class="ids-section">
                        <div class="ids-section-header flagged">
                            <span> Flagged (${flaggedIds.length})</span>
                            <button class="ids-copy-btn" onclick="copyToClipboard('${idsStr}')"> Copy</button>
                        </div>
                        <div class="ids-list">${idsStr}</div>
                    </div>
                `;
            }

            if (html === '') {
                html = '<p style="text-align: center; color: var(--text-light); padding: 40px;">No questions attempted yet.</p>';
            }

            body.innerHTML = html;
            modal.classList.add('show');
        }

        function closeIdsModal() {
            document.getElementById('question-ids-modal').classList.remove('show');
        }

        function copyToClipboard(text) {
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    // Visual feedback
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = ' Copied!';
                    btn.style.background = '#4caf50';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(err => {
                    console.error('Clipboard API failed, trying fallback:', err);
                    copyToClipboardFallback(text);
                });
            } else {
                // Fallback for older browsers
                copyToClipboardFallback(text);
            }
        }

        function copyToClipboardFallback(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                // Visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = ' Copied!';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // Click outside modal to close
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        document.getElementById('media-modal').addEventListener('click', (e) => {
            if (e.target.id === 'media-modal') {
                closeMediaModal();
            }
        });

        // ===== LAB VALUES MODAL FUNCTIONS =====
        function openLabValuesModal() {
            document.getElementById('labValuesModal').classList.add('show');
        }

        function closeLabValuesModal() {
            document.getElementById('labValuesModal').classList.remove('show');
        }

        // ===== CALCULATOR MODAL FUNCTIONS =====
        function openCalculatorModal() {
            document.getElementById('calculatorModal').classList.add('show');
        }

        function closeCalculatorModal() {
            document.getElementById('calculatorModal').classList.remove('show');
        }

        // Close modals on outside click
        document.getElementById('labValuesModal').addEventListener('click', (e) => {
            if (e.target.id === 'labValuesModal') {
                closeLabValuesModal();
            }
        });

        document.getElementById('calculatorModal').addEventListener('click', (e) => {
            if (e.target.id === 'calculatorModal') {
                closeCalculatorModal();
            }
        });
    </script>

    <!-- React Components for Lab Values and Calculator -->
    <script type="text/babel">
        // ===== CALCULATOR COMPONENT =====
        function Calculator() {
            const [calc, setCalc] = React.useState({
                display: "0",
                operator: null,
                temp: 0,
                resetDisplay: false,
                memory: 0,
                mode: "RAD",
            });

            React.useEffect(() => {
                const storedCalcState = localStorage.getItem("calcState");
                if (storedCalcState) {
                    setCalc(JSON.parse(storedCalcState));
                }
            }, []);

            const handleClick = (event) => {
                const value = event.target.getAttribute("data-value");
                let result;

                switch (value) {
                    case "+":
                    case "-":
                    case "*":
                    case "/":
                        if (calc.operator && !calc.resetDisplay) {
                            result = eval(`${calc.temp} ${calc.operator} ${calc.display}`);
                        } else {
                            result = calc.display;
                        }
                        setCalc({
                            ...calc,
                            operator: value,
                            temp: parseFloat(result),
                            display: result,
                            resetDisplay: true,
                        });
                        break;
                    case "=":
                        if (calc.operator) {
                            result = eval(`${calc.temp} ${calc.operator} ${calc.display}`);
                            setCalc({
                                ...calc,
                                display: String(result),
                                operator: null,
                                temp: 0,
                                resetDisplay: true,
                            });
                        }
                        break;
                    case "C":
                        setCalc({
                            display: "0",
                            operator: null,
                            temp: 0,
                            resetDisplay: false,
                            memory: calc.memory,
                            mode: calc.mode,
                        });
                        break;
                    case "+/-":
                        setCalc({
                            ...calc,
                            display: String(parseFloat(calc.display) * -1),
                        });
                        break;
                    case "%":
                        setCalc({
                            ...calc,
                            display: String(parseFloat(calc.display) / 100),
                        });
                        break;
                    default:
                        if (calc.display === "0" || calc.resetDisplay) {
                            setCalc({
                                ...calc,
                                display: value,
                                resetDisplay: false,
                            });
                        } else {
                            setCalc({
                                ...calc,
                                display: calc.display + value,
                                resetDisplay: false,
                            });
                        }
                        break;
                }

                setCalc((prevCalc) => {
                    const newCalc = { ...prevCalc };
                    localStorage.setItem("calcState", JSON.stringify(newCalc));
                    return newCalc;
                });
            };

            const handleKeyPress = (event) => {
                const key = event.key;
                let value = null;

                switch (key) {
                    case "1": case "2": case "3": case "4": case "5":
                    case "6": case "7": case "8": case "9": case "0":
                    case ".": case "+": case "-": case "*": case "/":
                        value = key;
                        break;
                    case "Enter":
                    case " ":
                    case "=":
                        value = "=";
                        break;
                    case "Escape":
                        value = "C";
                        break;
                    default:
                        return;
                }

                if (value) {
                    handleClick({ target: { getAttribute: () => value } });
                }
            };

            React.useEffect(() => {
                window.addEventListener("keydown", handleKeyPress);
                return () => window.removeEventListener("keydown", handleKeyPress);
            }, [calc]);

            return (
                <div style={{ minWidth: "320px" }}>
                    <div className="calc-display">
                        {calc.display || "0"}
                    </div>
                    <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: "8px", padding: "8px" }}>
                        <button data-value="C" onClick={handleClick}>C</button>
                        <button data-value="+/-" onClick={handleClick}>+/-</button>
                        <button data-value="%" onClick={handleClick}>%</button>
                        <button data-value="/" onClick={handleClick}></button>

                        <button data-value="7" onClick={handleClick}>7</button>
                        <button data-value="8" onClick={handleClick}>8</button>
                        <button data-value="9" onClick={handleClick}>9</button>
                        <button data-value="*" onClick={handleClick}></button>

                        <button data-value="4" onClick={handleClick}>4</button>
                        <button data-value="5" onClick={handleClick}>5</button>
                        <button data-value="6" onClick={handleClick}>6</button>
                        <button data-value="-" onClick={handleClick}></button>

                        <button data-value="1" onClick={handleClick}>1</button>
                        <button data-value="2" onClick={handleClick}>2</button>
                        <button data-value="3" onClick={handleClick}>3</button>
                        <button data-value="+" onClick={handleClick}>+</button>

                        <button data-value="0" style={{ gridColumn: "1 / span 2" }} onClick={handleClick}>0</button>
                        <button data-value="." onClick={handleClick}>.</button>
                        <button data-value="=" onClick={handleClick}>=</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Calculator />, document.getElementById('calculatorRoot'));

        // ===== LAB VALUES COMPONENT =====
        function LabValuesPopup() {
            const [activeTab, setActiveTab] = React.useState(
                localStorage.getItem("activeTab") || "Serum"
            );
            const [labData, setLabData] = React.useState({});
            const [siReference, setSiReference] = React.useState(false);
            const [searchTerm, setSearchTerm] = React.useState("");
            const [loaded, setLoaded] = React.useState(false);

            const scrollRef = React.useRef(null);
            const searchInputRef = React.useRef(null);

            const handleScroll = () => {
                if (scrollRef.current) {
                    const scrollPosition = scrollRef.current.scrollTop;
                    localStorage.setItem("scrollPosition", String(scrollPosition));
                }
            };

            React.useEffect(() => {
                const scrollContainer = scrollRef.current;
                if (!scrollContainer) return;

                const onScroll = () => {
                    const scrollPosition = scrollContainer.scrollTop;
                    localStorage.setItem("scrollPosition", String(scrollPosition));
                };

                scrollContainer.addEventListener("scroll", onScroll);
                return () => scrollContainer.removeEventListener("scroll", onScroll);
            }, []);

            React.useEffect(() => {
                if (labData && Object.keys(labData).length > 0 && scrollRef.current && !loaded) {
                    const savedScrollPosition = parseInt(
                        localStorage.getItem("scrollPosition") || "0",
                        10
                    );
                    scrollRef.current.scrollTop = savedScrollPosition;
                    setLoaded(true);
                }
            }, [labData, loaded]);

            React.useEffect(() => {
                const fetchLabData = async () => {
                    const storedSearchTerm = localStorage.getItem("searchTerm");
                    if (storedSearchTerm) {
                        setSearchTerm(storedSearchTerm);
                    }

                    const mockData = {
                Serum: [
                  {
                    name: "Alanine aminotransferase (ALT)",
                    range: "10-40 U/L",
                    siRange: "10-40 U/L",
                  },
                  {
                    name: "Aspartate aminotransferase (AST)",
                    range: "12-38 U/L",
                    siRange: "12-38 U/L",
                  },
                  {
                    name: "Alkaline phosphatase",
                    range: "25-100 U/L",
                    siRange: "25-100 U/L",
                  },
                  {
                    name: "Amylase",
                    range: "25-125 U/L",
                    siRange: "25-125 U/L",
                  },
                  { name: "Bilirubin", range: "", siRange: "" },
                  {
                    name: "Total",
                    range: "0.1-1.0 mg/dL",
                    siRange: "2-17 mol/L",
                  },
                  {
                    name: "Direct",
                    range: "0.0-0.3 mg/dL",
                    siRange: "0-5 mol/L",
                  },
                  {
                    name: "Calcium",
                    range: "8.4-10.2 mg/dL",
                    siRange: "2.1-2.6 mmol/L",
                  },
                  { name: "Cholesterol", range: "", siRange: "" },
                  { name: "Total", range: "", siRange: "" },
                  {
                    name: "Normal",
                    range: "<200 mg/dL",
                    siRange: "<5.2 mmol/L",
                  },
                  { name: "High", range: ">240mg/dL", siRange: ">6.2 mmol/L" },
                  {
                    name: "HDL",
                    range: "40-60 mg/dL",
                    siRange: "1.0-1.6 mmol/L",
                  },
                  { name: "LDL", range: "<160 mg/dL", siRange: "<4.2 mmol/L" },
                  { name: "Triglycerides", range: "", siRange: "" },
                  {
                    name: "Normal",
                    range: "<150 mg/dL",
                    siRange: "<1.70 mmol/L",
                  },
                  {
                    name: "Borderline",
                    range: "151-199 mg/dL",
                    siRange: "1.71-2.25 mmol/L",
                  },
                  { name: "Cortisol", range: "", siRange: "" },
                  {
                    name: "0800 h",
                    range: "5-23 g/dL",
                    siRange: "138-635 nmol/L",
                  },
                  {
                    name: "1600 h",
                    range: "3-15 g/dL",
                    siRange: "82-413 nmol/L",
                  },
                  {
                    name: "2000 h",
                    range: "<50% of 0800 h",
                    siRange: "Fraction of 0800 h: <0.50",
                  },
                  { name: "Creatine kinase", range: "", siRange: "" },
                  { name: "Male", range: "25-90 U/L", siRange: "25-90 U/L" },
                  { name: "Female", range: "10-70 U/L", siRange: "10-70 U/L" },
                  {
                    name: "Creatinine",
                    range: "0.6-1.2 mg/dL",
                    siRange: "53-106 mol/L",
                  },
                  {
                    name: "Urea nitrogen",
                    range: "7-18 mg/dL",
                    siRange: "1.2-3.0 mmol/L",
                  },
                  { name: "Electrolytes, serum", range: "", siRange: "" },
                  {
                    name: "Sodium (Na+)",
                    range: "136-146 mEq/L",
                    siRange: "136-146 mmol/L",
                  },
                  {
                    name: "Potassium (K+)",
                    range: "3.5-5.0 mEq/L",
                    siRange: "3.5-5.0 mmol/L",
                  },
                  {
                    name: "Chloride (Cl-)",
                    range: "95-105 mEq/L",
                    siRange: "95-105 mmol/L",
                  },
                  {
                    name: "Bicarbonate (HCO3-)",
                    range: "22-28 mEq/L",
                    siRange: "22-28 mmol/L",
                  },
                  {
                    name: "Magnesium (Mg2+)",
                    range: "1.5-2.0 mEq/L",
                    siRange: "0.75-1.0 mmol/L",
                  },
                  { name: "Ferritin", range: "", siRange: "" },
                  {
                    name: "Male:",
                    range: "20-250 ng/mL",
                    siRange: "20-250 g/L",
                  },
                  {
                    name: "Female:",
                    range: "10-120 ng/mL",
                    siRange: "10-120 g/L",
                  },
                  {
                    name: "Follicle-stimulating hormone",
                    range: "",
                    siRange: "",
                  },
                  { name: "Male", range: "4-25 mIU/mL", siRange: "4-25 U/L" },
                  { name: "Female", range: "", siRange: "" },
                  {
                    name: "premenopause",
                    range: "4-30 mIU/mL",
                    siRange: "4-30 U/L",
                  },
                  {
                    name: "midcycle peak",
                    range: "10-90 mIU/mL",
                    siRange: "10-90 U/L",
                  },
                  {
                    name: "postmenopause",
                    range: "40-250 mIU/mL",
                    siRange: "40-250 U/L",
                  },
                  { name: "Glucose", range: "", siRange: "" },
                  {
                    name: "Fasting",
                    range: "70-110 mg/dL",
                    siRange: "3.8-5.6 mmol/L",
                  },
                  {
                    name: "Random, non-fasting",
                    range: "<140 mg/dL",
                    siRange: "<7.7 mmol/L",
                  },
                  {
                    name: "Growth hormone- arginine stimulation",
                    range: "",
                    siRange: "",
                  },
                  { name: "Fasting", range: "<5 ng/mL", siRange: "<5 g/L" },
                  {
                    name: "Provocative stimuli",
                    range: ">7 ng/mL",
                    siRange: ">7 g/L",
                  },
                  { name: "Iron", range: "", siRange: "" },
                  {
                    name: "Male",
                    range: "65-175 g/dL",
                    siRange: "11.6-31.3 mol/L",
                  },
                  {
                    name: "Female",
                    range: "50-170 g/dL",
                    siRange: "9.0-30.4 mol/L",
                  },
                  {
                    name: "Total iron-binding capacity",
                    range: "250-400 g/dL",
                    siRange: "44.8-71.6 mol/L",
                  },
                  {
                    name: "Transferrin",
                    range: "200-360 mg/dL",
                    siRange: "2.0-3.6 g/L",
                  },
                  {
                    name: "Lactate dehydrogenase",
                    range: "45-200 U/L",
                    siRange: "45-200 U/L",
                  },
                  { name: "Luteinizing hormone", range: "", siRange: "" },
                  { name: "Male", range: "6-23 mIU/mL", siRange: "6-23 U/L" },
                  { name: "Female", range: "", siRange: "" },
                  {
                    name: "follicular phase",
                    range: "5-30 mIU/mL",
                    siRange: "5-30 U/L",
                  },
                  {
                    name: "midcycle",
                    range: "75-150 mIU/mL",
                    siRange: "75-150 U/L",
                  },
                  {
                    name: "postmenopause",
                    range: "30-200 mIU/mL",
                    siRange: "30-200 U/L",
                  },
                  {
                    name: "Osmolality",
                    range: "275-295 mOsmol/kg H2O",
                    siRange: "275-295 mOsmol/kg H2O",
                  },
                  {
                    name: "Intact parathyroid hormone (PTH)",
                    range: "10-60 pg/mL",
                    siRange: "10-60 ng/mL",
                  },
                  {
                    name: "Phosphorus (inorganic)",
                    range: "3.0-4.5 mg/dL",
                    siRange: "1.0-1.5 mmol/L",
                  },
                  { name: "Prolactin (hPRL)", range: "", siRange: "" },
                  { name: "Male", range: "<17 ng/mL", siRange: "<17 g/L" },
                  { name: "Female", range: "<25 ng/mL", siRange: "<25 g/L" },
                  { name: "Proteins", range: "", siRange: "" },
                  {
                    name: "Total",
                    range: "6.0-7.8 g/dL",
                    siRange: "60-78 g/L",
                  },
                  {
                    name: "Albumin",
                    range: "3.5-5.5 g/dL",
                    siRange: "35-55 g/L",
                  },
                  {
                    name: "Globulin",
                    range: "2.3-3.5 g/dL",
                    siRange: "23-35 g/L",
                  },
                  {
                    name: "Troponin I",
                    range: "<0.04 ng/dL",
                    siRange: "<0.04 g/L",
                  },
                  {
                    name: "TSH",
                    range: "0.4-4.0 U/mL",
                    siRange: "0.4-4.0 U/mL",
                  },
                  {
                    name: "Thyroidal iodine (123I) uptake",
                    range: "8%-30% of administered dose/24 h",
                    siRange: "0.08-0.30/24 h",
                  },
                  {
                    name: "Thyroxine (T4)",
                    range: "5-12 g/dL",
                    siRange: "64-155 nmol/L",
                  },
                  {
                    name: "Free (T4)",
                    range: "0.9-1.7 ng/dL",
                    siRange: "12.0-21.9 pmol/L",
                  },
                  {
                    name: "Triiodothyronine (T3) (RIA)",
                    range: "100-200 ng/dL",
                    siRange: "1.5-3.1 nmol/L",
                  },
                  {
                    name: "Triiodothyronine (T3) resin uptake",
                    range: "25%-35%",
                    siRange: "0.25-0.35",
                  },
                  {
                    name: "Uric acid",
                    range: "3.0-8.2 mg/dL",
                    siRange: "0.18-0.48 mmol/L",
                  },
                  { name: "Immunoglobulins", range: "", siRange: "" },
                  {
                    name: "IgA",
                    range: "76-390 mg/dL",
                    siRange: "0.76-3.90 g/L",
                  },
                  { name: "IgE", range: "0-380 IU/mL", siRange: "0-380 kIU/L" },
                  {
                    name: "IgG",
                    range: "650-1500 mg/dL",
                    siRange: "6.5-15.0 g/L",
                  },
                  {
                    name: "IgM",
                    range: "50-300 mg/dL",
                    siRange: "0.5-3.0 g/L",
                  },
                  {
                    name: "Gases, arterial blood (room air)",
                    range: "",
                    siRange: "",
                  },
                  {
                    name: "pH",
                    range: "7.35-7.45",
                    siRange: "[H+] 36-44 nmol/L",
                  },
                  {
                    name: "Pco2",
                    range: "33-45 mm Hg",
                    siRange: "4.4-5.9 kPa",
                  },
                  {
                    name: "Po2",
                    range: "75-105 mm Hg",
                    siRange: "10.0-14.0 kPa",
                  },
                ],
                Cerebrospinal: [
                  {
                    name: "Cell count",
                    range: "0-5/mm3",
                    siRange: "0-5 x 106/L",
                  },
                  {
                    name: "Chloride",
                    range: "118-132 mEq/L",
                    siRange: "118-132 mmol/L",
                  },
                  {
                    name: "Gamma globulin",
                    range: "3%-12% total proteins",
                    siRange: "0.03-0.12",
                  },
                  {
                    name: "Glucose",
                    range: "40-70 mg/dL",
                    siRange: "2.2-3.9 mmol/L",
                  },
                  {
                    name: "Pressure",
                    range: "70-180 mm H2O",
                    siRange: "70-180 mm H2O",
                  },
                  {
                    name: "Proteins, total",
                    range: "<40 mg/dL",
                    siRange: "<0.40 g/L",
                  },
                ],
                Blood: [
                  { name: "Erythrocyte count", range: "", siRange: "" },
                  {
                    name: "Male",
                    range: "4.3-5.9 million/mm3",
                    siRange: "4.3-5.9 x 1012/L",
                  },
                  {
                    name: "Female",
                    range: "3.5-5.5 million/mm3",
                    siRange: "3.5-5.5 x 1012/L",
                  },
                  {
                    name: "Erythrocyte sedimentation rate (Westergren)",
                    range: "",
                    siRange: "",
                  },
                  { name: "Male", range: "0-15 mm/h", siRange: "0-15 mm/h" },
                  { name: "Female", range: "0-20 mm/h", siRange: "0-20 mm/h" },
                  { name: "Hematocrit", range: "", siRange: "" },
                  { name: "Male", range: "41%-53%", siRange: "0.41-0.53" },
                  { name: "Female", range: "36%-46%", siRange: "0.36-0.46" },
                  { name: "Hemoglobin, blood", range: "", siRange: "" },
                  {
                    name: "Male",
                    range: "13.5-17.5 g/dL",
                    siRange: "135-175 g/L",
                  },
                  {
                    name: "Female",
                    range: "12.0-16.0 g/dL",
                    siRange: "120-160 g/L",
                  },
                  {
                    name: "Hemoglobin A1c",
                    range: "6%",
                    siRange: "42 mmol/mol",
                  },
                  {
                    name: "Hemoglobin, plasma",
                    range: "<4 mg/dL",
                    siRange: "<0.62 mmol/L",
                  },
                  {
                    name: "Leukocyte count (WBC)",
                    range: "4500-11,000/mm3",
                    siRange: "4.5-11.0 x 109/L",
                  },
                  {
                    name: "Neutrophils, segmented",
                    range: "54%-62%",
                    siRange: "0.54-0.62",
                  },
                  {
                    name: "Neutrophils, bands",
                    range: "3%-5%",
                    siRange: "0.03-0.05",
                  },
                  { name: "Eosinophils", range: "1%-3%", siRange: "0.01-0.03" },
                  {
                    name: "Basophils",
                    range: "0%-0.75%",
                    siRange: "0.00-0.0075",
                  },
                  {
                    name: "Lymphocytes",
                    range: "25%-33%",
                    siRange: "0.25-0.33",
                  },
                  { name: "Monocytes", range: "3%-7%", siRange: "0.03-0.07" },
                  {
                    name: "CD4+ T-lymphocyte count",
                    range: "500/mm3",
                    siRange: "0.5 x 109/L",
                  },
                  {
                    name: "Platelet count",
                    range: "150,000-400,000/mm3",
                    siRange: "150-400 x 109/L",
                  },
                  {
                    name: "Reticulocyte count",
                    range: "0.5%-1.5%",
                    siRange: "0.005-0.015",
                  },
                  {
                    name: "D-Dimer",
                    range: "250 ng/mL",
                    siRange: "1.4 nmol/L",
                  },
                  {
                    name: "Partial thromboplastin time (PTT)(activated)",
                    range: "25-40 seconds",
                    siRange: "25-40 seconds",
                  },
                  {
                    name: "Prothrombin time (PT)",
                    range: "11-15 seconds",
                    siRange: "11-15 seconds",
                  },
                  {
                    name: "Mean corpuscular hemoglobin (MCH)",
                    range: "25-35 pg/cell",
                    siRange: "0.39-0.54 fmol/cell",
                  },
                  {
                    name: "Mean corpuscular hemoglobin concentration (MCHC)",
                    range: "31%-36% Hb/cell",
                    siRange: "4.8-5.6 mmol Hb/L",
                  },
                  {
                    name: "Mean corpuscular volume (MCV)",
                    range: "80-100 m3",
                    siRange: "80-100 fL",
                  },
                  { name: "Volume", range: "", siRange: "" },
                  { name: "Plasma", range: "", siRange: "" },
                  {
                    name: "Male",
                    range: "25-43 mL/kg",
                    siRange: "0.025-0.043 L/kg",
                  },
                  {
                    name: "Female",
                    range: "28-45 mL/kg",
                    siRange: "0.028-0.045 L/kg",
                  },
                  { name: "Red cell", range: "", siRange: "" },
                  {
                    name: "Male",
                    range: "20-36 mL/kg",
                    siRange: "0.020-0.036 L/kg",
                  },
                  {
                    name: "Female",
                    range: "19-31 mL/kg",
                    siRange: "0.019-0.031 L/kg",
                  },
                ],
                "Urine and BMI": [
                  {
                    name: "Calcium",
                    range: "100-300 mg/24 h",
                    siRange: "2.5-7.5 mmol/24 h",
                  },
                  { name: "Creatinine clearance", range: "", siRange: "" },
                  {
                    name: "Male",
                    range: "97-137 mL/min",
                    siRange: "97-137 mL/min",
                  },
                  {
                    name: "Female",
                    range: "88-128 mL/min",
                    siRange: "88-128 mL/min",
                  },
                  {
                    name: "Osmolality",
                    range: "50-1200 mOsmol/kg H2O",
                    siRange: "50-1200 mmol/kg",
                  },
                  {
                    name: "Oxalate",
                    range: "8-40 g/mL",
                    siRange: "90-445 mol/L",
                  },
                  {
                    name: "Proteins, total",
                    range: "<150 mg/24 h",
                    siRange: "<0.15 g/24 h",
                  },
                  { name: "17-Hydroxycorticosteroids", range: "", siRange: "" },
                  {
                    name: "Male",
                    range: "3.0-10.0 mg/24 h",
                    siRange: "8.2-27.6 mol/24 h",
                  },
                  {
                    name: "Female",
                    range: "2.0-8.0 mg/24 h",
                    siRange: "5.5-22.0 mol/24 h",
                  },
                  { name: "17-Ketosteroids, total", range: "", siRange: "" },
                  {
                    name: "Male",
                    range: "8-20 mg/24 h",
                    siRange: "28-70 mol/24 h",
                  },
                  {
                    name: "Female",
                    range: "6-15 mg/24 h",
                    siRange: "21-52 mol/24 h",
                  },
                  {
                    name: "Body Mass Index (BMI)",
                    range: "Adult: 19-25 kg/m2",
                    siRange: "",
                  },
                ],
                    };

                    setLabData(mockData);
                };
                fetchLabData();
            }, []);

            const handleTabClick = (tabName) => {
                setActiveTab(tabName);
                localStorage.setItem("activeTab", tabName);
            };

            const highlightText = (text) => {
                if (!searchTerm) return text;
                const regex = new RegExp(`(${searchTerm})`, "gi");
                const parts = text.split(regex);
                return parts.map((part, index) =>
                    regex.test(part) ? (
                        <span key={index} style={{ backgroundColor: "#fffd88" }}>
                            {part}
                        </span>
                    ) : (
                        part
                    )
                );
            };

            const handleSearchChange = (e) => {
                const newSearchTerm = e.target.value;
                setSearchTerm(newSearchTerm);
                localStorage.setItem("searchTerm", newSearchTerm);
            };

            React.useEffect(() => {
                if (searchInputRef.current) {
                    searchInputRef.current.focus();
                }
            }, []);

            const isTabHighlighted = (tabName) => {
                return (
                    searchTerm &&
                    labData[tabName]?.some((item) =>
                        item.name.toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
            };

            return (
                <div style={{ padding: "1em", backgroundColor: "#fff", borderRadius: "8px" }}>
                    <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "1em" }}>
                        <h1 style={{ margin: 0 }}>Lab Values</h1>
                    </div>

                    <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "1em" }}>
                        <input
                            ref={searchInputRef}
                            type="search"
                            placeholder="Search lab values..."
                            value={searchTerm}
                            onChange={handleSearchChange}
                            style={{ padding: "6px", marginRight: "8px", flex: 1 }}
                        />
                        <label style={{ marginLeft: "1em" }}>
                            <input
                                type="checkbox"
                                checked={siReference}
                                onChange={() => setSiReference(!siReference)}
                            />{" "}
                            SI Reference
                        </label>
                    </div>

                    <div style={{ marginBottom: "1em" }}>
                        {["Serum", "Cerebrospinal", "Blood", "Urine and BMI"].map((tabName) => (
                            <button
                                key={tabName}
                                onClick={() => handleTabClick(tabName)}
                                style={{
                                    padding: "6px 10px",
                                    marginRight: "6px",
                                    fontWeight: activeTab === tabName ? "bold" : "normal",
                                    backgroundColor: isTabHighlighted(tabName) ? "#fffd88" : "",
                                }}
                            >
                                {tabName}
                            </button>
                        ))}
                    </div>

                    <div
                        ref={scrollRef}
                        onScroll={handleScroll}
                        style={{
                            maxHeight: "30vh",
                            overflowY: "auto",
                            border: "1px solid #ddd",
                            borderRadius: "4px",
                            scrollbarWidth: "thin",
                            scrollbarColor: "#3852a4 #f0f1f7",
                        }}
                    >
                        <table style={{ width: "100%", borderCollapse: "collapse" }}>
                            <thead>
                                <tr style={{ backgroundColor: "#f5f5f5" }}>
                                    <th style={{ textAlign: "left", padding: "8px", width: siReference ? "33%" : "50%" }}>
                                        {activeTab}
                                    </th>
                                    <th style={{ textAlign: "left", padding: "8px", width: siReference ? "33%" : "50%" }}>
                                        Reference Range
                                    </th>
                                    {siReference && (
                                        <th style={{ textAlign: "left", padding: "8px", width: "33%" }}>SI Reference</th>
                                    )}
                                </tr>
                            </thead>
                            <tbody>
                                {labData[activeTab]?.map((item, index) => (
                                    <tr
                                        key={index}
                                        style={{
                                            backgroundColor: index % 2 === 0 ? "#fafafa" : "#fff",
                                        }}
                                    >
                                        <td style={{ padding: "8px" }}>{highlightText(item.name)}</td>
                                        <td style={{ padding: "8px" }}>{item.range || ""}</td>
                                        {siReference && <td style={{ padding: "8px" }}>{item.siRange || ""}</td>}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<LabValuesPopup />, document.getElementById('labValuesRoot'));
    </script>


    <!-- Anki Converter Button -->
    <div id="ankiConverterButton" class="sidebar-float-btn" onclick="openAnkiConverterModal()" title="Anki Converter">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="#5f6368" width="32" height="32">
            <path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"/>
        </svg>
    </div>

    <!-- Study Planner Button -->
    <div id="studyPlannerButton" class="sidebar-float-btn" onclick="openStudyPlannerModal()" title="Study Planner">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#5f6368" width="32" height="32">
            <path d="M96 0C43 0 0 43 0 96V416c0 53 43 96 96 96H384h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V384c17.7 0 32-14.3 32-32V32c0-17.7-14.3-32-32-32H384 96zm0 384H352v64H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm32-240c0-8.8 7.2-16 16-16H336c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16zm16 48H336c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16s7.2-16 16-16z"/>
        </svg>
    </div>

    <!-- Lab Values Button -->
    <div id="labValuesButton" class="sidebar-float-btn" onclick="openLabValuesModal()" title="Open Lab Values">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" fill="#5f6368" width="32" height="32">
            <path d="M175 389.4c-9.8 16-15 34.3-15 53.1c-10 3.5-20.8 5.5-32 5.5c-53 0-96-43-96-96L32 64C14.3 64 0 49.7 0 32S14.3 0 32 0L96 0l64 0 64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l0 245.9-49 79.6zM96 64l0 96 64 0 0-96L96 64zM352 0L480 0l32 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l0 150.9L629.7 406.2c6.7 10.9 10.3 23.5 10.3 36.4c0 38.3-31.1 69.4-69.4 69.4l-309.2 0c-38.3 0-69.4-31.1-69.4-69.4c0-12.8 3.6-25.4 10.3-36.4L320 214.9 320 64c-17.7 0-32-14.3-32-32s14.3-32 32-32l32 0zm32 64l0 160c0 5.9-1.6 11.7-4.7 16.8L330.5 320l171 0-48.8-79.2c-3.1-5-4.7-10.8-4.7-16.8l0-160-64 0z"/>
        </svg>
    </div>

    <!-- Calculator Button -->
    <div id="calculatorButton" class="sidebar-float-btn" onclick="openCalculatorModal()" title="Open Calculator">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="#5f6368" width="32" height="32">
            <path d="M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-384c0-35.3-28.7-64-64-64L64 0zM96 64l192 0c17.7 0 32 14.3 32 32l0 32c0 17.7-14.3 32-32 32L96 160c-17.7 0-32-14.3-32-32l0-32c0-17.7 14.3-32 32-32zm32 160a32 32 0 1 1 -64 0 32 32 0 1 1 64 0zM96 352a32 32 0 1 1 0-64 32 32 0 1 1 0 64zM64 416c0-17.7 14.3-32 32-32l96 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-96 0c-17.7 0-32-14.3-32-32zM192 256a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm32 64a32 32 0 1 1 -64 0 32 32 0 1 1 64 0zm64-64a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm32 64a32 32 0 1 1 -64 0 32 32 0 1 1 64 0zM288 448a32 32 0 1 1 0-64 32 32 0 1 1 0 64z"/>
        </svg>
    </div>

    <!-- Stopwatch Container -->
    <div id="stopwatchContainer" class="sidebar-float-btn stopwatch-expanded">
        <button id="occludeBtn" class="occlude-btn" title="Occlude Stopwatch"></button>
        <div id="stopwatchDisplay" class="stopwatch-display">00:00</div>
        <div class="stopwatch-buttons">
            <button id="startPauseResumeBtn" class="stopwatch-btn">Start</button>
            <button id="stopBtn" class="stopwatch-btn">Stop</button>
        </div>
        <div class="stopwatch-option">
            <input type="checkbox" id="autoPauseOnSubmit" />
            <label for="autoPauseOnSubmit">Auto-pause on Submit</label>
        </div>
    </div>

    <!-- Stopwatch Icon (when occluded) -->
    <div id="stopwatchIcon" class="sidebar-float-btn" style="display: none;" onclick="unOccludeStopwatch()" title="Show Stopwatch">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#5f6368" width="32" height="32">
            <path d="M176 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l16 0 0 34.4C92.3 113.8 16 200 16 304c0 114.9 93.1 208 208 208s208-93.1 208-208c0-41.8-12.3-80.7-33.5-113.2l24.1-24.1c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L355.7 143c-28.1-23-62.2-38.8-99.7-44.6L256 64l16 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L224 0 176 0zm72 192l0 128c0 13.3-10.7 24-24 24s-24-10.7-24-24l0-128c0-13.3 10.7-24 24-24s24 10.7 24 24z"/>
        </svg>
    </div>

    <!-- Lab Values Modal -->
    <div id="labValuesModal" class="utility-modal">
        <div class="utility-modal-content">
            <div class="utility-modal-header">
                <h2>Lab Values</h2>
                <button class="utility-modal-close" onclick="closeLabValuesModal()">&times;</button>
            </div>
            <div id="labValuesRoot"></div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="utility-modal">
        <div class="utility-modal-content calculator-modal-content">
            <div class="utility-modal-header">
                <h2>Calculator</h2>
                <button class="utility-modal-close" onclick="closeCalculatorModal()">&times;</button>
            </div>
            <div id="calculatorRoot"></div>
        </div>
    </div>

    <!-- Stopwatch JavaScript (must be after HTML elements) -->
    <script>
        // ===== STOPWATCH FUNCTIONS =====
        const displayEl = document.getElementById('stopwatchDisplay');
        const startPauseResumeBtn = document.getElementById('startPauseResumeBtn');
        const stopBtn = document.getElementById('stopBtn');
        const occludeBtn = document.getElementById('occludeBtn');
        const containerEl = document.getElementById('stopwatchContainer');
        const iconEl = document.getElementById('stopwatchIcon');

        let stopwatchState = 'stopped'; // 'stopped', 'running', 'paused'
        let elapsedMs = 0;
        let lastTickTime = 0;
        let timerInterval = null;

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const mm = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            const ss = String(totalSeconds % 60).padStart(2, '0');
            return mm + ':' + ss;
        }

        function updateDisplay(msValue) {
            displayEl.textContent = formatTime(msValue);
        }

        function startTimeInterval() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (stopwatchState === 'running') {
                    const now = Date.now();
                    const diff = now - lastTickTime;
                    lastTickTime = now;
                    elapsedMs += diff;
                    updateDisplay(elapsedMs);
                    saveStopwatchState();
                }
            }, 1000);
        }

        function startStopwatch() {
            stopwatchState = 'running';
            lastTickTime = Date.now();
            startPauseResumeBtn.textContent = 'Pause';
            startTimeInterval();
            saveStopwatchState();
        }

        function pauseStopwatch() {
            clearInterval(timerInterval);
            stopwatchState = 'paused';
            const now = Date.now();
            const diff = now - lastTickTime;
            elapsedMs += diff;
            updateDisplay(elapsedMs);
            startPauseResumeBtn.textContent = 'Resume';
            saveStopwatchState();
        }

        function stopStopwatch() {
            clearInterval(timerInterval);
            stopwatchState = 'stopped';
            elapsedMs = 0;
            lastTickTime = 0;
            updateDisplay(0);
            startPauseResumeBtn.textContent = 'Start';
            saveStopwatchState();
        }

        startPauseResumeBtn.addEventListener('click', () => {
            // Check if in test mode and show warning
            if (isTestMode && stopwatchState !== 'stopped') {
                if (!confirm(' Warning: Manual timer changes will affect test metrics!\n\nThis will impact:\n Total test time\n Average time per question\n\nDo you want to proceed?')) {
                    return;
                }
            }

            if (stopwatchState === 'stopped') {
                startStopwatch();
            } else if (stopwatchState === 'running') {
                pauseStopwatch();
            } else if (stopwatchState === 'paused') {
                startStopwatch();
            }
        });

        stopBtn.addEventListener('click', () => {
            // Check if in test mode and show warning
            if (isTestMode && stopwatchState !== 'stopped') {
                if (!confirm(' Warning: Stopping the timer will affect test metrics!\n\nThis will impact:\n Total test time\n Average time per question\n\nDo you want to proceed?')) {
                    return;
                }
            }
            stopStopwatch();
        });

        occludeBtn.addEventListener('click', () => {
            containerEl.style.display = 'none';
            iconEl.style.display = 'flex';
            updateUIPositions();
        });

        function unOccludeStopwatch() {
            iconEl.style.display = 'none';
            containerEl.style.display = 'flex';
            updateUIPositions();
        }

        function updateUIPositions() {
            const calcBtn = document.getElementById('calculatorButton');
            const labBtn = document.getElementById('labValuesButton');
            const plannerBtn = document.getElementById('studyPlannerButton');
            const ankiBtn = document.getElementById('ankiConverterButton');

            if (containerEl.style.display === 'none') {
                // When stopwatch is hidden (just icon showing)
                calcBtn.style.bottom = '90px';
                labBtn.style.bottom = '150px';
                plannerBtn.style.bottom = '220px';
                ankiBtn.style.bottom = '290px';
            } else {
                // When stopwatch is visible (expanded with checkbox)
                calcBtn.style.bottom = '220px';
                labBtn.style.bottom = '290px';
                plannerBtn.style.bottom = '360px';
                ankiBtn.style.bottom = '430px';
            }
        }

        function saveStopwatchState() {
            const data = {
                stopwatchState,
                elapsedMs,
                lastTickTime
            };
            localStorage.setItem('stopwatchState', JSON.stringify(data));
        }

        function loadStopwatchState() {
            const stored = localStorage.getItem('stopwatchState');
            if (!stored) return;
            try {
                const parsed = JSON.parse(stored);
                if (parsed.stopwatchState) stopwatchState = parsed.stopwatchState;
                if (typeof parsed.elapsedMs === 'number') elapsedMs = parsed.elapsedMs;
                if (typeof parsed.lastTickTime === 'number') lastTickTime = parsed.lastTickTime;

                updateDisplay(elapsedMs);
                if (stopwatchState === 'running') {
                    startPauseResumeBtn.textContent = 'Pause';
                    lastTickTime = Date.now();
                    startTimeInterval();
                } else if (stopwatchState === 'paused') {
                    startPauseResumeBtn.textContent = 'Resume';
                }
            } catch (err) {
                console.error('Error parsing stored stopwatch state:', err);
            }
        }

        // Load stopwatch state on page load
        loadStopwatchState();

        // Update button positions after loading stopwatch state
        updateUIPositions();

        // Auto-pause on Submit feature
        const autoPauseCheckbox = document.getElementById('autoPauseOnSubmit');
        let wasRunningBeforePause = false;

        // Load auto-pause preference
        const autoPausePref = localStorage.getItem('autoPauseOnSubmit');
        if (autoPausePref === 'true') {
            autoPauseCheckbox.checked = true;
        }

        // Save auto-pause preference when changed
        autoPauseCheckbox.addEventListener('change', () => {
            localStorage.setItem('autoPauseOnSubmit', autoPauseCheckbox.checked);
        });

        // Listen for Submit/Explanation open/close from iframe
        window.addEventListener('message', (event) => {
            if (event.data.type === 'submitOpened') {
                // Only pause if checkbox is checked and timer is running
                if (autoPauseCheckbox.checked && stopwatchState === 'running') {
                    wasRunningBeforePause = true;
                    pauseStopwatch();
                }
            } else if (event.data.type === 'submitClosed') {
                // Resume if it was paused by submitOpened
                if (autoPauseCheckbox.checked && wasRunningBeforePause && stopwatchState === 'paused') {
                    wasRunningBeforePause = false;
                    startStopwatch();
                }
            }
        });

        // Auto-resume when changing questions (if was auto-paused)
        function resumeTimerOnQuestionChange() {
            if (autoPauseCheckbox.checked && wasRunningBeforePause && stopwatchState === 'paused') {
                wasRunningBeforePause = false;
                startStopwatch();
            }
        }

        // Fullscreen Mode Functions
        let navbarTimeout, sidebarTimeout;
        let fullscreenMouseMoveHandler = null;
        let sidebarManuallyOpened = false;

        function toggleSidebarFullscreen() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarIndicator = document.getElementById('sidebar-indicator');

            if (sidebar.classList.contains('hover-active')) {
                // Close sidebar - indicator moves back to left edge
                sidebar.classList.remove('hover-active');
                sidebarManuallyOpened = false;
            } else {
                // Open sidebar - indicator moves with it
                sidebar.classList.add('hover-active');
                sidebarManuallyOpened = true;
            }
        }

        function enterFullscreen() {
            document.body.classList.add('fullscreen-mode');

            const navbar = document.querySelector('.navbar');
            const sidebar = document.querySelector('.sidebar');
            const sidebarIndicator = document.getElementById('sidebar-indicator');

            // Reset manual state
            sidebarManuallyOpened = false;

            // Remove existing handler if any
            if (fullscreenMouseMoveHandler) {
                document.removeEventListener('mousemove', fullscreenMouseMoveHandler);
            }

            // Create and add new handler
            fullscreenMouseMoveHandler = function(e) {
                if (!document.body.classList.contains('fullscreen-mode')) return;

                // Navbar hover - show on top edge hover (first 50px)
                if (e.clientY < 50) {
                    navbar.classList.add('hover-active');
                    clearTimeout(navbarTimeout);
                } else if (e.clientY > 100 && navbar.classList.contains('hover-active')) {
                    navbarTimeout = setTimeout(() => {
                        navbar.classList.remove('hover-active');
                    }, 300);
                }

                // Sidebar hover - only if not manually opened
                if (!sidebarManuallyOpened) {
                    if (e.clientX < 50) {
                        sidebar.classList.add('hover-active');
                        clearTimeout(sidebarTimeout);
                    } else if (e.clientX > sidebar.offsetWidth + 50 && sidebar.classList.contains('hover-active')) {
                        sidebarTimeout = setTimeout(() => {
                            sidebar.classList.remove('hover-active');
                        }, 300);
                    }
                }
            };

            document.addEventListener('mousemove', fullscreenMouseMoveHandler);
        }

        function exitFullscreen() {
            console.log('exitFullscreen called');
            document.body.classList.remove('fullscreen-mode');

            // Remove event listener
            if (fullscreenMouseMoveHandler) {
                document.removeEventListener('mousemove', fullscreenMouseMoveHandler);
                fullscreenMouseMoveHandler = null;
            }

            // Remove hover classes
            const navbar = document.querySelector('.navbar');
            const sidebar = document.querySelector('.sidebar');
            const sidebarIndicator = document.getElementById('sidebar-indicator');

            if (navbar) navbar.classList.remove('hover-active');
            if (sidebar) sidebar.classList.remove('hover-active');
            if (sidebarIndicator) sidebarIndicator.classList.remove('hide');

            // Clear timeouts
            clearTimeout(navbarTimeout);
            clearTimeout(sidebarTimeout);
        }

        // Keyboard shortcuts for fullscreen
        document.addEventListener('keydown', function(e) {
            // F key for fullscreen (when not in input)
            if (e.key === 'f' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                if (document.body.classList.contains('fullscreen-mode')) {
                    exitFullscreen();
                } else if (document.getElementById('question-iframe')) {
                    enterFullscreen();
                }
            }

            // Escape key to exit fullscreen
            if (e.key === 'Escape' && document.body.classList.contains('fullscreen-mode')) {
                exitFullscreen();
            }
        });
    </script>

</body>
</html>
